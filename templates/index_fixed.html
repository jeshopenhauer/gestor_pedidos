{% extends "base.html" %}

{% block title %}Gestor de Pedidos{% endblock %}

{% block content %}
<div class="content">
    <!-- Header principal -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="color: #374151; font-size: 2rem; margin: 0;">Gestor de pedidos</h1>
        <a href="{{ url_for('crear_pedido') }}" class="btn btn-primary">+ Crear pedido</a>
    </div>

    <!-- Panel de pedidos -->
    <div class="card">
        <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 1.5rem;">Panel de pedidos</h2>
        
        {% if pedidos %}
            {% for pedido in pedidos %}
            <div class="pedido-card" data-pedido-id="{{ pedido.id }}" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: white;">
                <!-- Header del pedido -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <h3 style="color: #1f2937; margin: 0; font-size: 1.2rem;">Pedido #{{ pedido.id }}</h3>
                        <p style="color: #6b7280; margin: 5px 0 0 0; font-size: 14px;">
                            {{ pedido.fecha_creacion }} - {{ pedido.oferta.proveedor }} - 
                            ‚Ç¨{{ "%.2f"|format(pedido.oferta.precio_total_oferta) }}
                        </p>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <button class="btn-icon" onclick="toggleDetalles('{{ pedido.id }}')" 
                                title="Ver m√°s detalles" style="background: none; border: none; cursor: pointer; padding: 5px;">
                            <span id="toggle-icon-{{ pedido.id }}" style="font-size: 16px;">‚ñº</span>
                        </button>
                        <a href="{{ url_for('pedido_detalle', pedido_id=pedido.id) }}" 
                           class="btn-icon" title="Ver detalle completo" 
                           style="text-decoration: none; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 4px; padding: 5px 8px;">
                            üëÅÔ∏è
                        </a>
                    </div>
                </div>

                <!-- Timeline de estados -->
                <div style="position: relative; display: flex; align-items: center; margin: 20px 0; padding: 0 20px;">
                    <div style="position: absolute; top: 50%; left: 20px; right: 20px; height: 2px; background: #e5e7eb; z-index: 1;"></div>
                    
                    {% set estados = ['oferta_recibida', 'eproc_borrador', 'eproc_enviado', 'bulto_recibido', 'paquete_creado', 'tar_creado', 'etiqueta_creada'] %}
                    {% set nombres_estados = {
                        'oferta_recibida': 'Oferta',
                        'eproc_borrador': 'Eproc',
                        'eproc_enviado': 'Enviado',
                        'bulto_recibido': 'Bulto',
                        'paquete_creado': 'Paquete',
                        'tar_creado': 'TAR',
                        'etiqueta_creada': 'Etiqueta'
                    } %}
                    
                    {% for estado in estados %}
                    <div style="position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; flex: 1;">
                        {% set estado_actual = estados.index(pedido.estado) %}
                        {% set estado_iter = loop.index0 %}
                        
                        <div class="timeline-circle {% if estado_iter <= estado_actual %}active{% endif %}">
                            {% if estado_iter < estado_actual %}‚úì{% else %}{{ loop.index }}{% endif %}
                        </div>
                        <span class="timeline-label {% if estado_iter <= estado_actual %}active{% endif %}">
                            {{ nombres_estados[estado] }}
                        </span>
                    </div>
                    {% endfor %}
                </div>

                <!-- Navegaci√≥n de estados -->
                <div style="display: flex; justify-content: center; gap: 15px; margin: 20px 0;">
                    {% if pedido.estado != 'oferta_recibida' %}
                        <button class="btn btn-secondary btn-sm" 
                                onclick="retrocederEstado('{{ pedido.id }}')"
                                title="Retroceder estado">
                            ‚Üê Anterior
                        </button>
                    {% endif %}
                    
                    {% if pedido.estado == 'oferta_recibida' %}
                        <a href="{{ url_for('formulario_eproc', pedido_id=pedido.id) }}" 
                           class="btn btn-primary btn-sm">Crear Eproc</a>
                    {% elif pedido.estado != 'etiqueta_creada' %}
                        <button class="btn btn-primary btn-sm" 
                                onclick="avanzarEstado('{{ pedido.id }}')"
                                title="Avanzar al siguiente estado">
                            Siguiente ‚Üí
                        </button>
                    {% else %}
                        <span class="btn btn-success btn-sm" style="cursor: default;">‚úì Completado</span>
                    {% endif %}
                </div>

                <!-- Panel de detalles expandible -->
                <div id="detalles-{{ pedido.id }}" class="detalles-panel" style="display: none;">
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 20px; margin-top: 20px;">
                        <h4 style="color: #374151; margin-bottom: 15px;">Informaci√≥n del proceso</h4>
                        
                        <!-- Informaci√≥n de la oferta -->
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 10px;">OFERTA RECIBIDA</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                <div>
                                    <p><strong>N√∫mero:</strong> {{ pedido.oferta.numero_oferta }}</p>
                                    <p><strong>Email:</strong> {{ pedido.oferta.email_proveedor }}</p>
                                </div>
                                <div>
                                    <p><strong>Items:</strong> {{ pedido.oferta.items|length }}</p>
                                    {% if pedido.oferta.fecha_validez %}
                                    <p><strong>V√°lida hasta:</strong> {{ pedido.oferta.fecha_validez }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Informaci√≥n del Eproc si existe -->
                        {% if pedido.eproc %}
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 10px;">EPROC</h5>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                                <div>
                                    <p><strong>N√∫mero:</strong> {{ pedido.eproc.eproc_number }}</p>
                                    {% if pedido.eproc.oi %}
                                    <p><strong>OI:</strong> {{ pedido.eproc.oi }}</p>
                                    {% endif %}
                                </div>
                                <div>
                                    <p><strong>Creado:</strong> {{ pedido.eproc.fecha_creacion }}</p>
                                    {% if pedido.eproc.fecha_envio %}
                                    <p><strong>Enviado:</strong> {{ pedido.eproc.fecha_envio }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Informaci√≥n adicional seg√∫n el estado -->
                        {% if pedido.bulto %}
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 10px;">BULTO RECIBIDO</h5>
                            <div style="font-size: 14px;">
                                <p><strong>Fecha recepci√≥n:</strong> {{ pedido.bulto.fecha_recepcion }}</p>
                                <p><strong>Piezas:</strong> {{ pedido.bulto.piezas|length }}</p>
                            </div>
                        </div>
                        {% endif %}

                        {% if pedido.paquete %}
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 10px;">PAQUETE CREADO</h5>
                            <div style="font-size: 14px;">
                                <p><strong>Fecha creaci√≥n:</strong> {{ pedido.paquete.fecha_creacion }}</p>
                                <p><strong>Piezas:</strong> {{ pedido.paquete.piezas|length }}</p>
                            </div>
                        </div>
                        {% endif %}

                        {% if pedido.tar %}
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 10px;">TAR CREADO</h5>
                            <div style="font-size: 14px;">
                                <p><strong>N√∫mero TAR:</strong> {{ pedido.tar.numero_tar }}</p>
                                <p><strong>Fecha:</strong> {{ pedido.tar.fecha_creacion }}</p>
                            </div>
                        </div>
                        {% endif %}

                        {% if pedido.etiqueta %}
                        <div style="margin-bottom: 20px;">
                            <h5 style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 10px;">ETIQUETA CREADA</h5>
                            <div style="font-size: 14px;">
                                <p><strong>C√≥digo:</strong> {{ pedido.etiqueta.codigo_etiqueta }}</p>
                                <p><strong>Fecha:</strong> {{ pedido.etiqueta.fecha_creacion }}</p>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Simulaci√≥n de PDFs -->
                        <div style="margin-top: 20px;">
                            <h5 style="color: #6b7280; font-size: 14px; font-weight: 600; margin-bottom: 10px;">DOCUMENTOS</h5>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <span class="pdf-tag">üìÑ Oferta_{{ pedido.oferta.numero_oferta }}.pdf</span>
                                {% if pedido.eproc %}
                                <span class="pdf-tag">üìÑ Eproc_{{ pedido.eproc.eproc_number }}.pdf</span>
                                {% endif %}
                                {% if pedido.tar %}
                                <span class="pdf-tag">üìÑ TAR_{{ pedido.tar.numero_tar }}.pdf</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 40px; color: #6b7280;">
                <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
                <p style="font-size: 18px; margin-bottom: 15px;">No hay pedidos registrados</p>
                <p style="margin-bottom: 20px;">Comience creando su primer pedido</p>
                <a href="{{ url_for('crear_pedido') }}" class="btn btn-primary">+ Crear primer pedido</a>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Funci√≥n para expandir/contraer detalles
function toggleDetalles(pedidoId) {
    const detalles = document.getElementById(`detalles-${pedidoId}`);
    const icon = document.getElementById(`toggle-icon-${pedidoId}`);
    
    if (detalles.style.display === 'none' || detalles.style.display === '') {
        detalles.style.display = 'block';
        icon.textContent = '‚ñ≤';
    } else {
        detalles.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

// Funci√≥n para avanzar estado
function avanzarEstado(pedidoId) {
    if (confirm('¬øEst√° seguro de que desea avanzar al siguiente estado?')) {
        fetch(`/api/pedidos/${pedidoId}/avanzar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al avanzar el estado');
        });
    }
}

// Funci√≥n para retroceder estado
function retrocederEstado(pedidoId) {
    if (confirm('¬øEst√° seguro de que desea retroceder al estado anterior?')) {
        fetch(`/api/pedidos/${pedidoId}/retroceder`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al retroceder el estado');
        });
    }
}
</script>
{% endblock %}

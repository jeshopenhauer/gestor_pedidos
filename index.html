<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📦 Gestor de Pedidos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8fafc;
            color: #374151;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;  /* Aumentado de 1200px */
            margin: 0 auto;
            padding: 30px;      /* Aumentado de 20px */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 25px;      /* Aumentado de 20px */
            border-radius: 12px; /* Aumentado de 8px */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Mejorado */
        }

        .header h1 {
            color: #0062ff;
            font-size: 2rem;
            margin: 0;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .pedido-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;    /* Aumentado de 8px */
            padding: 25px;          /* Aumentado de 20px */
            margin-bottom: 25px;    /* Aumentado de 20px */
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Añadido */
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;    /* Aumentado de 15px */
        }

        .pedido-info h3 {
            color: #1f2937;
            margin: 0;
            font-size: 1.4rem;      /* Aumentado de 1.2rem */
        }

        .pedido-info p {
            color: #6b7280;
            margin: 5px 0 0 0;
            font-size: 14px;
        }

        .pedido-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-icon {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-icon:hover {
            background: #e5e7eb;
        }

        .timeline {
            position: relative;
            display: flex;
            align-items: center;
            margin: 25px 0;      /* Aumentado de 20px */
            padding: 0 25px;     /* Aumentado de 20px */
            min-height: 80px;    /* Añadido */
        }

        .timeline-line {
            position: absolute;
            top: 50%;
            left: 25px;          /* Aumentado de 20px */
            right: 25px;         /* Aumentado de 20px */
            height: 3px;         /* Aumentado de 2px */
            background: #e5e7eb;
            z-index: 1;
        }

        .timeline-step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            padding: 0 8px;      /* Añadido */
        }

        .timeline-circle {
            width: 45px;         /* Aumentado de 40px */
            height: 45px;        /* Aumentado de 40px */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;     /* Aumentado de 14px */
            background: #e5e7eb;
            color: #6b7280;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Añadido */
        }

        .timeline-circle.active {
            background: #10b981;
            color: white;
            transform: scale(1.1); /* Añadido */
        }

        .timeline-label {
            margin-top: 10px;    /* Aumentado de 8px */
            font-size: 13px;     /* Aumentado de 12px */
            text-align: center;
            color: #6b7280;
            font-weight: 500;    /* Añadido */
        }

        .timeline-label.active {
            color: #10b981;
            font-weight: 600;
        }

        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .detalles-panel {
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
            margin-top: 20px;
            display: none;
        }

        .detalles-panel.show {
            display: block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section h5 {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .pdf-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .pdf-tag {
            background: #f3f4f6;
            color: #374151;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #d1d5db;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .pdf-tag:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        .pdf-tag.clickable {
            background: #dbeafe;
            border-color: #93c5fd;
            color: #1d4ed8;
        }

        .pdf-tag.clickable:hover {
            background: #bfdbfe;
            border-color: #60a5fa;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .pieces-container {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            background: #f9fafb;
            min-height: 350px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        #pieces-grid {
            min-width: 975px; /* Asegurar ancho mínimo para el grid */
        }

        .piece-row {
            display: grid;
            grid-template-columns: 180px 280px 160px 120px 140px 80px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid #f3f4f6;
        }

        .piece-row input {
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        .piece-row input[type="number"] {
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .piece-row input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .total-row {
            text-align: right;
            font-weight: bold;
            font-size: 16px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            color: #059669;
        }

        .hidden {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 12px;
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📦 Gestor de pedidos</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn btn-secondary" onclick="abrirShortDescriptionGenerator()" title="Abrir generador de descripciones">
                    🧮 Short Description Generator
                </button>
                <button class="btn" onclick="abrirModalCrearPedido()">+ Crear pedido</button>
            </div>
        </div>

        <!-- Panel de pedidos -->
        <div class="card">
            <h2 style="color: #1f2937; margin-bottom: 20px; font-size: 1.5rem;">Panel de pedidos</h2>
            
            <div id="pedidos-container">
                <!-- Aquí se mostrarán los pedidos dinámicamente -->
            </div>

            <!-- Estado vacío -->
            <div id="empty-state" class="empty-state">
                <div class="icon">📋</div>
                <p style="font-size: 18px; margin-bottom: 15px;">No hay pedidos registrados</p>
                <p style="margin-bottom: 20px;">Comience creando su primer pedido</p>
                <button class="btn" onclick="abrirModalCrearPedido()">+ Crear primer pedido</button>
            </div>
        </div>
    </div>

    <!-- Modal para crear pedido -->
    <div id="modal-crear-pedido" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Nuevo Pedido</h2>
                <span class="close" onclick="cerrarModal()">&times;</span>
            </div>
            
            <form id="form-crear-pedido">
                <div class="form-group">
                    <label for="numero_oferta">Número de Oferta</label>
                    <input type="text" id="numero_oferta" name="numero_oferta">
                </div>

                <div class="form-group">
                    <label for="proveedor">Proveedor</label>
                    <input type="text" id="proveedor" name="proveedor">
                </div>

                <div class="form-group">
                    <label for="email_proveedor">Email Proveedor</label>
                    <input type="email" id="email_proveedor" name="email_proveedor">
                </div>

                <div class="form-group">
                    <label for="fecha_oferta">Fecha de la Oferta</label>
                    <input type="date" id="fecha_oferta" name="fecha_oferta">
                </div>

                <div class="form-group">
                    <label for="oferta_pdf">PDF de la Oferta</label>
                    <input type="file" id="oferta_pdf" name="oferta_pdf" accept=".pdf">
                </div>

                <div class="pieces-container">
                    <h3 style="margin-bottom: 20px; color: #374151;">Piezas del Pedido</h3>
                    <div id="pieces-grid">
                        <div class="piece-row" style="background: #374151; color: white; font-weight: bold; border-radius: 8px;">
                            <div style="padding: 12px 15px;">Referencia</div>
                            <div style="padding: 12px 15px;">Descripción</div>
                            <div style="padding: 12px 15px;">Proyecto</div>
                            <div style="padding: 12px 15px;">Cantidad</div>
                            <div style="padding: 12px 15px;">Precio Unit. (€)</div>
                            <div style="padding: 12px 15px;">Acción</div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="agregarPieza()" style="margin-top: 15px;">+ Agregar Pieza</button>
                    <div class="total-row">
                        Total: €<span id="total-pedido">0.00</span>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn">Crear Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para lanzar Eproc -->
    <div id="modal-lanzar-eproc" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lanzar Eproc</h2>
                <span class="close" onclick="cerrarModalLanzarEproc()">&times;</span>
            </div>
            
            <form id="form-lanzar-eproc">
                <input type="hidden" id="lanzar-eproc-pedido-id">
                
                <div class="form-group">
                    <label for="lanzar_eproc_numero">Número Eproc</label>
                    <input type="text" id="lanzar_eproc_numero" name="numero">
                </div>

                <div class="form-group">
                    <label for="lanzar_eproc_oi">OI</label>
                    <input type="text" id="lanzar_eproc_oi" name="oi">
                </div>

                <div class="form-group">
                    <label for="lanzar_eproc_fecha">Fecha</label>
                    <input type="date" id="lanzar_eproc_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalLanzarEproc()">Cancelar</button>
                    <button type="submit" class="btn">Lanzar Eproc</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para firmar Eproc -->
    <div id="modal-firmar-eproc" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Firmar Eproc</h2>
                <span class="close" onclick="cerrarModalFirmarEproc()">&times;</span>
            </div>
            
            <form id="form-firmar-eproc">
                <input type="hidden" id="firmar-eproc-pedido-id">
                
                <div class="form-group">
                    <label for="firmar_eproc_pdf">PDF de la PO</label>
                    <input type="file" id="firmar_eproc_pdf" name="pdf" accept=".pdf">
                </div>

                <div class="form-group">
                    <label for="firmar_eproc_po">Número PO</label>
                    <input type="text" id="firmar_eproc_po" name="po">
                </div>

                <div class="form-group">
                    <label for="firmar_eproc_fecha">Fecha</label>
                    <input type="date" id="firmar_eproc_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalFirmarEproc()">Cancelar</button>
                    <button type="submit" class="btn">Firmar Eproc</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para crear Packing List -->
    <div id="modal-packing-list" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Crear Packing List</h2>
                <span class="close" onclick="cerrarModalPackingList()">&times;</span>
            </div>
            
            <form id="form-packing-list">
                <input type="hidden" id="packing-list-pedido-id">
                
                <div class="form-group">
                    <label for="packing_list_pdf">PDF del Packing List</label>
                    <input type="file" id="packing_list_pdf" name="pdf" accept=".pdf">
                </div>

                <div class="form-group">
                    <label for="packing_list_direccion">Dirección de entrega</label>
                    <textarea id="packing_list_direccion" name="direccion" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <label for="packing_list_bultos">Número de bultos</label>
                    <input type="number" id="packing_list_bultos" name="bultos" min="1" onchange="generarConfiguracionBultos()">
                </div>

                <div class="form-group">
                    <label for="packing_list_fecha">Fecha</label>
                    <input type="date" id="packing_list_fecha" name="fecha">
                </div>

                <div class="form-group">
                    <label for="packing_list_peso_total">Peso Total (kg)</label>
                    <input type="number" id="packing_list_peso_total" name="peso_total" step="0.1" min="0" placeholder="0.0">
                </div>

                <!-- Configuración de bultos -->
                <div id="configuracion-bultos-container" style="margin-top: 20px; display: none;">
                    <h3 style="color: #374151; margin-bottom: 15px;">Configuración de Bultos</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">Asigne las piezas a cada bulto:</p>
                    
                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                        <!-- Lista de piezas disponibles -->
                        <div style="flex: 1; min-width: 250px;">
                            <h4 style="margin-bottom: 10px; color: #374151;">Piezas Disponibles</h4>
                            <div id="piezas-disponibles" style="
                                border: 2px solid #d1d5db; 
                                border-radius: 8px; 
                                padding: 15px; 
                                background: #f9fafb;
                                min-height: 300px;
                                max-height: 400px;
                                overflow-y: auto;
                            ">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                        
                        <!-- Botones de control -->
                        <div style="display: flex; flex-direction: column; gap: 10px; padding-top: 40px;">
                            <button type="button" onclick="moverPiezaABulto()" style="
                                padding: 10px 15px;
                                border: 2px solid #374151;
                                background: #374151;
                                color: white;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">→</button>
                            <button type="button" onclick="regresarPiezaADisponibles()" style="
                                padding: 10px 15px;
                                border: 2px solid #374151;
                                background: white;
                                color: #374151;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">←</button>
                        </div>
                        
                        <!-- Bultos -->
                        <div style="flex: 2; min-width: 300px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #374151;">Bultos</h4>
                                <select id="bulto-selector" style="
                                    padding: 5px 10px;
                                    border: 2px solid #d1d5db;
                                    border-radius: 6px;
                                    background: white;
                                ">
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            
                            <!-- Información del bulto seleccionado -->
                            <div id="info-bulto-container" style="margin-bottom: 15px; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #f3f4f6; border-radius: 6px; margin-bottom: 10px;">
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block;">Peso (kg)</label>
                                        <input type="number" id="bulto-peso" step="0.1" min="0" placeholder="0.0" style="
                                            width: 100%; 
                                            padding: 5px; 
                                            border: 1px solid #d1d5db; 
                                            border-radius: 4px;
                                            font-size: 14px;
                                        " onchange="actualizarInfoBulto()">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block;">Dimensiones (cm)</label>
                                        <input type="text" id="bulto-dimensiones" placeholder="L x W x H" style="
                                            width: 100%; 
                                            padding: 5px; 
                                            border: 1px solid #d1d5db; 
                                            border-radius: 4px;
                                            font-size: 14px;
                                        " onchange="actualizarInfoBulto()">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="bulto-contenido" style="
                                border: 2px solid #d1d5db; 
                                border-radius: 8px; 
                                padding: 15px; 
                                background: white;
                                min-height: 300px;
                                max-height: 400px;
                                overflow-y: auto;
                            ">
                                <p style="color: #9ca3af; text-align: center; margin-top: 50px;">
                                    Seleccione un bulto y use los botones para asignar piezas
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalPackingList()">Cancelar</button>
                    <button type="submit" class="btn">Crear Packing List</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para lanzar TAR -->
    <div id="modal-lanzar-tar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lanzar TAR</h2>
                <span class="close" onclick="cerrarModalLanzarTar()">&times;</span>
            </div>
            
            <form id="form-lanzar-tar">
                <input type="hidden" id="lanzar-tar-pedido-id">
                
                <div class="form-group">
                    <label for="lanzar_tar_numero">Número TAR</label>
                    <input type="text" id="lanzar_tar_numero" name="numero">
                </div>

                <div class="form-group">
                    <label for="lanzar_tar_email">Email Logística</label>
                    <input type="email" id="lanzar_tar_email" name="email">
                </div>

                <div class="form-group">
                    <label for="lanzar_tar_url">URL</label>
                    <input type="url" id="lanzar_tar_url" name="url">
                </div>

                <div class="form-group">
                    <label for="lanzar_tar_fecha">Fecha</label>
                    <input type="date" id="lanzar_tar_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalLanzarTar()">Cancelar</button>
                    <button type="submit" class="btn">Lanzar TAR</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para enviar etiquetas -->
    <div id="modal-enviar-etiquetas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Enviar Etiquetas</h2>
                <span class="close" onclick="cerrarModalEnviarEtiquetas()">&times;</span>
            </div>
            
            <form id="form-enviar-etiquetas">
                <input type="hidden" id="enviar-etiquetas-pedido-id">
                
                <div class="form-group">
                    <label for="enviar_etiquetas_pdf">PDF de las etiquetas</label>
                    <input type="file" id="enviar_etiquetas_pdf" name="pdf" accept=".pdf">
                </div>

                <div class="form-group">
                    <label for="enviar_etiquetas_tracking">Número de tracking</label>
                    <input type="text" id="enviar_etiquetas_tracking" name="tracking">
                </div>

                <div class="form-group">
                    <label for="enviar_etiquetas_fecha">Fecha</label>
                    <input type="date" id="enviar_etiquetas_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalEnviarEtiquetas()">Cancelar</button>
                    <button type="submit" class="btn">Enviar Etiquetas</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver detalles completos -->
    <div id="modal-detalle-completo" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="detalle-titulo">Detalles del Pedido</h2>
                <span class="close" onclick="cerrarModalDetalle()">&times;</span>
            </div>
            
            <div id="detalle-contenido" style="max-height: 70vh; overflow-y: auto;">
                <!-- Se llenará dinámicamente -->
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalDetalle()">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        // Datos en memoria
        let pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
        let nextId = parseInt(localStorage.getItem('nextId')) || 1;

        // Estados del workflow (9 estados sin bultos)
        const ESTADOS = [
            'oferta_recibida', 
            'eproc_lanzado', 
            'eproc_firmado', 
            'packing_list_creado', 
            'tar_lanzado', 
            'etiquetas_enviadas', 
            'recibido_planta', 
            'sin_incidencias', 
            'completado'
        ];
        const NOMBRES_ESTADOS = {
            'oferta_recibida': 'Oferta<br>Recibida',
            'eproc_lanzado': 'Eproc<br>Lanzado',
            'eproc_firmado': 'Eproc<br>Firmado',
            'packing_list_creado': 'Packing<br>List',
            'tar_lanzado': 'TAR<br>Lanzado',
            'etiquetas_enviadas': 'Etiquetas<br>Enviadas',
            'recibido_planta': 'Paquete<br>Recogido',
            'sin_incidencias': 'Paquete<br>en Casa',
            'completado': 'Paquete<br>Recogido'
        };

        // Función para obtener nombres de estados sin HTML
        function getNombreEstadoTexto(estado) {
            const nombres = {
                'oferta_recibida': 'Oferta Recibida',
                'eproc_lanzado': 'Eproc Lanzado', 
                'eproc_firmado': 'Eproc Firmado',
                'packing_list_creado': 'Packing List',
                'tar_lanzado': 'TAR Lanzado',
                'etiquetas_enviadas': 'Etiquetas Enviadas',
                'recibido_planta': 'Paquete Recogido',
                'sin_incidencias': 'Paquete en Casa',
                'completado': 'Paquete Recogido'
            };
            return nombres[estado] || estado;
        }

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            mostrarPedidos();
            agregarPieza(); // Agregar una pieza inicial
        });

        // Función para obtener la fecha de hoy en formato YYYY-MM-DD
        function obtenerFechaHoy() {
            const hoy = new Date();
            return hoy.toISOString().split('T')[0];
        }

        // Guardar datos en localStorage
        function guardarDatos() {
            localStorage.setItem('pedidos', JSON.stringify(pedidos));
            localStorage.setItem('nextId', nextId.toString());
        }

        // Mostrar pedidos
        function mostrarPedidos() {
            const container = document.getElementById('pedidos-container');
            const emptyState = document.getElementById('empty-state');
            
            if (pedidos.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = pedidos.map(pedido => crearTarjetaPedido(pedido)).join('');
        }

        // Crear tarjeta de pedido
        function crearTarjetaPedido(pedido) {
            const estadoIndex = ESTADOS.indexOf(pedido.estado);
            
            return `
                <div class="pedido-card" data-pedido-id="${pedido.id}">
                    <div class="pedido-header">
                        <div class="pedido-info">
                            <h3>Pedido #${pedido.id}</h3>
                            <p>${pedido.fecha_creacion} - ${pedido.proveedor} - €${pedido.total.toFixed(2)}</p>
                        </div>
                        <div class="pedido-actions">
                            <button class="btn-icon" onclick="toggleDetalles(${pedido.id})" title="Ver más detalles">
                                <span id="toggle-icon-${pedido.id}">▼</span>
                            </button>
                            <button class="btn-icon" onclick="mostrarDetalleCompleto(${pedido.id})" title="Ver detalle completo" style="background: #dbeafe; border-color: #93c5fd; color: #1d4ed8;">
                                👁️
                            </button>
                            <button class="btn-icon" onclick="eliminarPedido(${pedido.id})" title="Eliminar pedido" style="background: #fee2e2; border-color: #fecaca; color: #dc2626;">
                                🗑️
                            </button>
                        </div>
                    </div>

                    <div class="timeline">
                        <div class="timeline-line"></div>
                        ${ESTADOS.map((estado, index) => `
                            <div class="timeline-step">
                                <div class="timeline-circle ${index <= estadoIndex ? 'active' : ''}">
                                    ${index <= estadoIndex ? '✓' : index + 1}
                                </div>
                                <span class="timeline-label ${index <= estadoIndex ? 'active' : ''}">
                                    ${NOMBRES_ESTADOS[estado]}
                                </span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="navigation-buttons">
                        ${pedido.estado !== 'oferta_recibida' ? `
                            <button class="btn btn-secondary btn-sm" onclick="retrocederEstado(${pedido.id})">
                                ← Anterior
                            </button>
                        ` : ''}
                        
                        ${pedido.estado === 'oferta_recibida' ? `
                            <button class="btn btn-sm" onclick="lanzarEproc(${pedido.id})">Lanzar Eproc</button>
                        ` : pedido.estado === 'eproc_lanzado' ? `
                            <button class="btn btn-sm" onclick="firmarEproc(${pedido.id})">Firmar Eproc</button>
                        ` : pedido.estado === 'eproc_firmado' ? `
                            <button class="btn btn-sm" onclick="crearPackingList(${pedido.id})">Crear Packing List</button>
                        ` : pedido.estado === 'packing_list_creado' ? `
                            <button class="btn btn-sm" onclick="lanzarTar(${pedido.id})">Lanzar TAR</button>
                        ` : pedido.estado === 'tar_lanzado' ? `
                            <button class="btn btn-sm" onclick="enviarEtiquetas(${pedido.id})">Enviar Etiquetas</button>
                        ` : pedido.estado === 'etiquetas_enviadas' ? `
                            <button class="btn btn-sm" onclick="avanzarEstado(${pedido.id})">Paquete recogido al proveedor</button>
                        ` : pedido.estado === 'recibido_planta' ? `
                            <button class="btn btn-sm" onclick="avanzarEstado(${pedido.id})">Paquete ha llegado al almacén</button>
                        ` : pedido.estado === 'sin_incidencias' ? `
                            <button class="btn btn-sm" onclick="avanzarEstado(${pedido.id})">Paquete recogido</button>
                        ` : `
                            <span class="btn btn-success btn-sm" style="cursor: default;">✓ Completado</span>
                        `}
                    </div>

                    <div id="detalles-${pedido.id}" class="detalles-panel">
                        <h4 style="margin-bottom: 15px;">Información del proceso</h4>
                        
                        <div class="info-section">
                            <h5>Oferta Recibida</h5>
                            <div class="info-grid">
                                <div>
                                    <p><strong>Número:</strong> ${pedido.numero_oferta}</p>
                                    <p><strong>Proveedor:</strong> ${pedido.proveedor}</p>
                                    <p><strong>Email:</strong> ${pedido.email_proveedor || 'N/A'}</p>
                                    <p><strong>Total:</strong> €${pedido.total.toFixed(2)}</p>
                                </div>
                                <div>
                                    <p><strong>Fecha:</strong> ${pedido.fecha_oferta || 'N/A'}</p>
                                </div>
                            </div>
                        </div>

                        ${pedido.eproc ? `
                            <div class="info-section">
                                <h5>Eproc Lanzado</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Número:</strong> ${pedido.eproc.numero}</p>
                                        ${pedido.eproc.oi ? `<p><strong>OI:</strong> ${pedido.eproc.oi}</p>` : ''}
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.eproc.fecha}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${pedido.eproc_firmado ? `
                            <div class="info-section">
                                <h5>Eproc Firmado</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>PO:</strong> ${pedido.eproc_firmado.po}</p>
                                        <p><strong>Fecha:</strong> ${pedido.eproc_firmado.fecha}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${pedido.packing_list ? `
                            <div class="info-section">
                                <h5>Packing List</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Dirección:</strong> ${pedido.packing_list.direccion}</p>
                                        <p><strong>Bultos:</strong> ${pedido.packing_list.bultos}</p>
                                        <p><strong>Peso Total:</strong> ${pedido.packing_list.peso_total || 0} kg</p>
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.packing_list.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                                ${pedido.configuracion_bultos ? `
                                    <div style="margin-top: 15px;">
                                        <h6 style="color: #374151; font-weight: 600; margin-bottom: 10px;">Configuración de Bultos:</h6>
                                        ${Object.entries(pedido.configuracion_bultos).map(([bulto, piezas]) => {
                                            const infoBulto = pedido.info_bultos && pedido.info_bultos[bulto];
                                            return `
                                                <div style="margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                                    <strong>${bulto.replace('_', ' ').charAt(0).toUpperCase() + bulto.replace('_', ' ').slice(1)}:</strong>
                                                    ${infoBulto ? `<span style="color: #6b7280; font-size: 12px;"> (${infoBulto.peso}kg${infoBulto.dimensiones ? `, ${infoBulto.dimensiones}` : ''})</span>` : ''}
                                                    <br>
                                                    ${piezas.length > 0 ? piezas.map(p => `${p.referencia} (${p.cantidad})`).join(', ') : 'Sin asignar'}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        ${pedido.tar ? `
                            <div class="info-section">
                                <h5>TAR Lanzado</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Número:</strong> ${pedido.tar.numero}</p>
                                        <p><strong>Email Logística:</strong> ${pedido.tar.email}</p>
                                        <p><strong>URL:</strong> ${pedido.tar.url}</p>
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.tar.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${pedido.etiquetas ? `
                            <div class="info-section">
                                <h5>Etiquetas Enviadas</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Tracking:</strong> ${pedido.etiquetas.tracking}</p>
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.etiquetas.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="info-section">
                            <h5>Documentos</h5>
                            <div class="pdf-tags">
                                <span class="pdf-tag clickable" onclick="abrirPDF('Oferta_${pedido.numero_oferta}.pdf', '${getFileData(pedido, 'oferta')}')" 
                                      title="Click para abrir PDF">📄 Oferta_${pedido.numero_oferta}.pdf</span>
                                ${pedido.eproc_firmado ? `<span class="pdf-tag clickable" onclick="abrirPDF('PO_${pedido.eproc_firmado.po}.pdf', '${getFileData(pedido, 'po')}')" 
                                      title="Click para abrir PDF">📄 PO_${pedido.eproc_firmado.po}.pdf</span>` : ''}
                                ${pedido.packing_list ? `<span class="pdf-tag clickable" onclick="abrirPDF('PackingList_${pedido.id}.pdf', '${getFileData(pedido, 'packing')}')" 
                                      title="Click para abrir PDF">📄 PackingList_${pedido.id}.pdf</span>` : ''}
                                ${pedido.etiquetas ? `<span class="pdf-tag clickable" onclick="abrirPDF('Etiquetas_${pedido.etiquetas.tracking}.pdf', '${getFileData(pedido, 'etiquetas')}')" 
                                      title="Click para abrir PDF">📄 Etiquetas_${pedido.etiquetas.tracking}.pdf</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal functions
        function abrirModalCrearPedido() {
            document.getElementById('modal-crear-pedido').style.display = 'block';
            document.getElementById('form-crear-pedido').reset();
            document.getElementById('fecha_oferta').value = obtenerFechaHoy();
            limpiarPiezas();
            agregarPieza();
        }

        function abrirShortDescriptionGenerator() {
            window.open('index_short_descrition_generator.html', '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');
        }

        function cerrarModal() {
            document.getElementById('modal-crear-pedido').style.display = 'none';
        }

        // Funciones para los nuevos modales
        function cerrarModalLanzarEproc() {
            document.getElementById('modal-lanzar-eproc').style.display = 'none';
        }

        function cerrarModalFirmarEproc() {
            document.getElementById('modal-firmar-eproc').style.display = 'none';
        }

        function cerrarModalPackingList() {
            document.getElementById('modal-packing-list').style.display = 'none';
        }

        function cerrarModalLanzarTar() {
            document.getElementById('modal-lanzar-tar').style.display = 'none';
        }

        function cerrarModalEnviarEtiquetas() {
            document.getElementById('modal-enviar-etiquetas').style.display = 'none';
        }

        function cerrarModalDetalle() {
            document.getElementById('modal-detalle-completo').style.display = 'none';
        }

        // Función para mostrar detalle completo en modal
        function mostrarDetalleCompleto(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) return;

            document.getElementById('detalle-titulo').textContent = `Detalles del Pedido #${pedido.id}`;
            
            const contenido = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="info-section">
                        <h3 style="color: #374151; margin-bottom: 15px; font-size: 18px;">📋 Información General</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                            <p><strong>ID:</strong> ${pedido.id}</p>
                            <p><strong>Número de Oferta:</strong> ${pedido.numero_oferta}</p>
                            <p><strong>Proveedor:</strong> ${pedido.proveedor}</p>
                            <p><strong>Email Proveedor:</strong> ${pedido.email_proveedor || 'N/A'}</p>
                            <p><strong>Fecha Creación:</strong> ${pedido.fecha_creacion}</p>
                            <p><strong>Fecha Oferta:</strong> ${pedido.fecha_oferta || 'N/A'}</p>
                            <p><strong>Estado Actual:</strong> <span style="color: #10b981; font-weight: bold;">${getNombreEstadoTexto(pedido.estado)}</span></p>
                            <p><strong>Total:</strong> <span style="color: #059669; font-weight: bold;">€${pedido.total.toFixed(2)}</span></p>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3 style="color: #374151; margin-bottom: 15px; font-size: 18px;">📦 Piezas del Pedido</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                            ${pedido.piezas.map(pieza => `
                                <div style="border-bottom: 1px solid #e5e7eb; padding: 8px 0;">
                                    <p style="margin: 2px 0;"><strong>${pieza.referencia}</strong> - ${pieza.descripcion}</p>
                                    <p style="margin: 2px 0; font-size: 12px; color: #6b7280;">Proyecto: ${pieza.proyecto} | Cantidad: ${pieza.cantidad} | Precio: €${pieza.precio_unitario.toFixed(2)}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                ${pedido.eproc ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">🚀 EPROC Lanzado</h3>
                        <div style="background: #dbeafe; padding: 12px; border-radius: 6px;">
                            <p><strong>Número:</strong> ${pedido.eproc.numero}</p>
                            <p><strong>OI:</strong> ${pedido.eproc.oi || 'N/A'}</p>
                            <p><strong>Fecha:</strong> ${pedido.eproc.fecha || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                ${pedido.eproc_firmado ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">✍️ EPROC Firmado</h3>
                        <div style="background: #dcfce7; padding: 12px; border-radius: 6px;">
                            <p><strong>Número PO:</strong> ${pedido.eproc_firmado.po}</p>
                            <p><strong>Fecha:</strong> ${pedido.eproc_firmado.fecha}</p>
                            <p><strong>PDF:</strong> ${pedido.eproc_firmado.pdf || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                ${pedido.packing_list ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">📦 Packing List</h3>
                        <div style="background: #fef3c7; padding: 12px; border-radius: 6px;">
                            <p><strong>Dirección:</strong> ${pedido.packing_list.direccion}</p>
                            <p><strong>Número de Bultos:</strong> ${pedido.packing_list.bultos}</p>
                            <p><strong>Peso Total:</strong> ${pedido.packing_list.peso_total || 0} kg</p>
                            <p><strong>Fecha:</strong> ${pedido.packing_list.fecha || 'N/A'}</p>
                            <p><strong>PDF:</strong> ${pedido.packing_list.pdf || 'N/A'}</p>
                            ${pedido.configuracion_bultos ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                    <p style="font-weight: 600; margin-bottom: 10px;">Configuración de Bultos:</p>
                                    ${Object.entries(pedido.configuracion_bultos).map(([bulto, piezas]) => {
                                        const infoBulto = pedido.info_bultos && pedido.info_bultos[bulto];
                                        return `
                                            <div style="margin-bottom: 10px; padding: 10px; background: #fffbeb; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                                <p style="font-weight: 600; color: #92400e;">
                                                    ${bulto.replace('_', ' ').charAt(0).toUpperCase() + bulto.replace('_', ' ').slice(1)}
                                                    ${infoBulto ? `<span style="font-weight: normal; color: #6b7280;"> - ${infoBulto.peso}kg${infoBulto.dimensiones ? `, ${infoBulto.dimensiones}` : ''}</span>` : ''}
                                                </p>
                                                <p style="margin-top: 5px; color: #451a03;">
                                                    ${piezas.length > 0 ? piezas.map(p => `${p.referencia} - ${p.descripcion} (Cant: ${p.cantidad})`).join('<br>') : 'Sin piezas asignadas'}
                                                </p>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}

                ${pedido.tar ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">🚚 TAR Lanzado</h3>
                        <div style="background: #fce7f3; padding: 12px; border-radius: 6px;">
                            <p><strong>Número TAR:</strong> ${pedido.tar.numero}</p>
                            <p><strong>Email Logística:</strong> ${pedido.tar.email}</p>
                            <p><strong>URL:</strong> ${pedido.tar.url || 'N/A'}</p>
                            <p><strong>Fecha:</strong> ${pedido.tar.fecha || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                ${pedido.etiquetas ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">🏷️ Etiquetas Enviadas</h3>
                        <div style="background: #e0e7ff; padding: 12px; border-radius: 6px;">
                            <p><strong>Tracking:</strong> ${pedido.etiquetas.tracking}</p>
                            <p><strong>Fecha:</strong> ${pedido.etiquetas.fecha || 'N/A'}</p>
                            <p><strong>PDF:</strong> ${pedido.etiquetas.pdf || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                <div class="info-section">
                    <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">📄 Documentos</h3>
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 6px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span class="pdf-tag clickable" onclick="abrirPDF('Oferta_${pedido.numero_oferta}.pdf', '${getFileData(pedido, 'oferta')}')" 
                                  title="Click para abrir PDF">📄 Oferta_${pedido.numero_oferta}.pdf</span>
                            ${pedido.eproc_firmado ? `<span class="pdf-tag clickable" onclick="abrirPDF('PO_${pedido.eproc_firmado.po}.pdf', '${getFileData(pedido, 'po')}')" 
                                  title="Click para abrir PDF">📄 PO_${pedido.eproc_firmado.po}.pdf</span>` : ''}
                            ${pedido.packing_list ? `<span class="pdf-tag clickable" onclick="abrirPDF('PackingList_${pedido.id}.pdf', '${getFileData(pedido, 'packing')}')" 
                                  title="Click para abrir PDF">📄 PackingList_${pedido.id}.pdf</span>` : ''}
                            ${pedido.etiquetas ? `<span class="pdf-tag clickable" onclick="abrirPDF('Etiquetas_${pedido.etiquetas.tracking}.pdf', '${getFileData(pedido, 'etiquetas')}')" 
                                  title="Click para abrir PDF">📄 Etiquetas_${pedido.etiquetas.tracking}.pdf</span>` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('detalle-contenido').innerHTML = contenido;
            document.getElementById('modal-detalle-completo').style.display = 'block';
        }

        // Funciones de piezas
        function agregarPieza() {
            const grid = document.getElementById('pieces-grid');
            const pieceCount = grid.children.length;
            
            const pieceRow = document.createElement('div');
            pieceRow.className = 'piece-row';
            pieceRow.innerHTML = `
                <input type="text" name="referencia_${pieceCount}" placeholder="REF-001">
                <input type="text" name="descripcion_${pieceCount}" placeholder="Descripción de la pieza">
                <input type="text" name="proyecto_${pieceCount}" placeholder="Proyecto A">
                <input type="number" name="cantidad_${pieceCount}" value="1" min="1" onchange="calcularTotal()">
                <input type="number" name="precio_${pieceCount}" step="0.01" min="0" placeholder="0.00" onchange="calcularTotal()">
                <button type="button" class="btn btn-secondary" onclick="eliminarPieza(this)" style="padding: 10px 15px; font-size: 14px; font-weight: bold; width: 100%;">×</button>
            `;
            
            grid.appendChild(pieceRow);
        }

        function eliminarPieza(button) {
            button.parentElement.remove();
            calcularTotal();
        }

        function limpiarPiezas() {
            const grid = document.getElementById('pieces-grid');
            while (grid.children.length > 1) {
                grid.removeChild(grid.lastChild);
            }
        }

        function calcularTotal() {
            const grid = document.getElementById('pieces-grid');
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseFloat(row.children[3].value) || 0;
                const precio = parseFloat(row.children[4].value) || 0;
                total += cantidad * precio;
            }
            
            document.getElementById('total-pedido').textContent = total.toFixed(2);
        }

        // Toggle detalles
        function toggleDetalles(pedidoId) {
            const detalles = document.getElementById(`detalles-${pedidoId}`);
            const icon = document.getElementById(`toggle-icon-${pedidoId}`);
            
            if (detalles.classList.contains('show')) {
                detalles.classList.remove('show');
                icon.textContent = '▼';
            } else {
                detalles.classList.add('show');
                icon.textContent = '▲';
            }
        }

        // Funciones específicas para cada estado
        function lanzarEproc(pedidoId) {
            document.getElementById('modal-lanzar-eproc').style.display = 'block';
            document.getElementById('lanzar-eproc-pedido-id').value = pedidoId;
            
            // Valores por defecto
            const año = new Date().getFullYear();
            document.getElementById('lanzar_eproc_numero').value = `EP${año}-${pedidoId.toString().padStart(3, '0')}`;
            document.getElementById('lanzar_eproc_fecha').value = obtenerFechaHoy();
        }

        function firmarEproc(pedidoId) {
            document.getElementById('modal-firmar-eproc').style.display = 'block';
            document.getElementById('firmar-eproc-pedido-id').value = pedidoId;
            document.getElementById('firmar_eproc_fecha').value = obtenerFechaHoy();
        }

        function crearPackingList(pedidoId) {
            document.getElementById('modal-packing-list').style.display = 'block';
            document.getElementById('packing-list-pedido-id').value = pedidoId;
            document.getElementById('packing_list_fecha').value = obtenerFechaHoy();
            
            // Resetear configuración de bultos
            document.getElementById('configuracion-bultos-container').style.display = 'none';
            document.getElementById('packing_list_bultos').value = '';
        }

        function generarConfiguracionBultos() {
            const numBultos = parseInt(document.getElementById('packing_list_bultos').value);
            const pedidoId = parseInt(document.getElementById('packing-list-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (!numBultos || !pedido) {
                document.getElementById('configuracion-bultos-container').style.display = 'none';
                return;
            }

            document.getElementById('configuracion-bultos-container').style.display = 'block';
            
            // Inicializar datos globales para la configuración
            window.piezasDisponibles = [...pedido.piezas];
            window.configuracionBultos = {};
            window.infoBultos = {};
            
            // Inicializar bultos vacíos con información adicional
            for (let i = 1; i <= numBultos; i++) {
                window.configuracionBultos[`bulto_${i}`] = [];
                window.infoBultos[`bulto_${i}`] = {
                    peso: 0,
                    dimensiones: ''
                };
            }
            
            // Llenar selector de bultos
            const selector = document.getElementById('bulto-selector');
            selector.innerHTML = '';
            for (let i = 1; i <= numBultos; i++) {
                const option = document.createElement('option');
                option.value = `bulto_${i}`;
                option.textContent = `Bulto ${i}`;
                selector.appendChild(option);
            }
            
            // Cargar primera vista
            mostrarPiezasDisponibles();
            mostrarContenidoBulto();
            cargarInfoBulto();
            
            // Event listener para cambio de bulto
            selector.onchange = () => {
                mostrarContenidoBulto();
                cargarInfoBulto();
            };
        }

        function mostrarPiezasDisponibles() {
            const container = document.getElementById('piezas-disponibles');
            container.innerHTML = '';
            
            window.piezasDisponibles.forEach((pieza, index) => {
                const div = document.createElement('div');
                div.className = 'pieza-item';
                div.style.cssText = `
                    padding: 10px;
                    margin: 5px 0;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                div.onclick = () => seleccionarPieza(div, index);
                div.innerHTML = `
                    <div style="font-weight: 600; color: #374151;">${pieza.referencia}</div>
                    <div style="font-size: 12px; color: #6b7280;">${pieza.descripcion}</div>
                    <div style="font-size: 12px; color: #059669;">Cantidad: ${pieza.cantidad}</div>
                `;
                container.appendChild(div);
            });
        }

        function mostrarContenidoBulto() {
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            const container = document.getElementById('bulto-contenido');
            
            if (!bultoSeleccionado) return;
            
            const piezasEnBulto = window.configuracionBultos[bultoSeleccionado] || [];
            container.innerHTML = '';
            
            if (piezasEnBulto.length === 0) {
                container.innerHTML = `
                    <p style="color: #9ca3af; text-align: center; margin-top: 50px;">
                        Este bulto está vacío.<br>
                        Seleccione piezas de la izquierda y use el botón → para agregar.
                    </p>
                `;
                return;
            }
            
            piezasEnBulto.forEach((pieza, index) => {
                const div = document.createElement('div');
                div.className = 'pieza-en-bulto';
                div.style.cssText = `
                    padding: 10px;
                    margin: 5px 0;
                    border: 1px solid #10b981;
                    border-radius: 6px;
                    background: #ecfdf5;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                div.onclick = () => seleccionarPiezaEnBulto(div, index);
                div.innerHTML = `
                    <div style="font-weight: 600; color: #065f46;">${pieza.referencia}</div>
                    <div style="font-size: 12px; color: #047857;">${pieza.descripcion}</div>
                    <div style="font-size: 12px; color: #059669;">Cantidad: ${pieza.cantidad}</div>
                `;
                container.appendChild(div);
            });
        }

        function cargarInfoBulto() {
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            const infoContainer = document.getElementById('info-bulto-container');
            
            if (!bultoSeleccionado) {
                infoContainer.style.display = 'none';
                return;
            }
            
            infoContainer.style.display = 'block';
            
            const infoBulto = window.infoBultos[bultoSeleccionado];
            document.getElementById('bulto-peso').value = infoBulto.peso;
            document.getElementById('bulto-dimensiones').value = infoBulto.dimensiones;
        }

        function actualizarInfoBulto() {
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            
            if (!bultoSeleccionado) return;
            
            const peso = parseFloat(document.getElementById('bulto-peso').value) || 0;
            const dimensiones = document.getElementById('bulto-dimensiones').value || '';
            
            window.infoBultos[bultoSeleccionado] = {
                peso: peso,
                dimensiones: dimensiones
            };
            
            // Actualizar peso total automáticamente
            actualizarPesoTotal();
        }

        function actualizarPesoTotal() {
            let pesoTotal = 0;
            Object.values(window.infoBultos || {}).forEach(info => {
                pesoTotal += info.peso || 0;
            });
            
            document.getElementById('packing_list_peso_total').value = pesoTotal.toFixed(1);
        }

        function seleccionarPieza(elemento, index) {
            // Limpiar selecciones anteriores
            document.querySelectorAll('.pieza-item').forEach(item => {
                item.style.background = 'white';
                item.style.borderColor = '#d1d5db';
            });
            document.querySelectorAll('.pieza-en-bulto').forEach(item => {
                item.style.background = '#ecfdf5';
                item.style.borderColor = '#10b981';
            });
            
            // Seleccionar elemento actual
            elemento.style.background = '#dbeafe';
            elemento.style.borderColor = '#3b82f6';
            window.piezaSeleccionadaIndex = index;
            window.piezaSeleccionadaEnBulto = null;
        }

        function seleccionarPiezaEnBulto(elemento, index) {
            // Limpiar selecciones anteriores
            document.querySelectorAll('.pieza-item').forEach(item => {
                item.style.background = 'white';
                item.style.borderColor = '#d1d5db';
            });
            document.querySelectorAll('.pieza-en-bulto').forEach(item => {
                item.style.background = '#ecfdf5';
                item.style.borderColor = '#10b981';
            });
            
            // Seleccionar elemento actual
            elemento.style.background = '#fef3c7';
            elemento.style.borderColor = '#f59e0b';
            window.piezaSeleccionadaEnBulto = index;
            window.piezaSeleccionadaIndex = null;
        }

        function moverPiezaABulto() {
            if (window.piezaSeleccionadaIndex === null || window.piezaSeleccionadaIndex === undefined) {
                alert('Seleccione una pieza de la lista de disponibles');
                return;
            }
            
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            
            if (!bultoSeleccionado) {
                alert('Seleccione un bulto');
                return;
            }
            
            // Mover pieza
            const pieza = window.piezasDisponibles[window.piezaSeleccionadaIndex];
            window.configuracionBultos[bultoSeleccionado].push(pieza);
            window.piezasDisponibles.splice(window.piezaSeleccionadaIndex, 1);
            
            // Actualizar vistas
            mostrarPiezasDisponibles();
            mostrarContenidoBulto();
            
            // Limpiar selección
            window.piezaSeleccionadaIndex = null;
        }

        function regresarPiezaADisponibles() {
            if (window.piezaSeleccionadaEnBulto === null || window.piezaSeleccionadaEnBulto === undefined) {
                alert('Seleccione una pieza del bulto');
                return;
            }
            
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            
            if (!bultoSeleccionado) return;
            
            // Mover pieza de vuelta
            const pieza = window.configuracionBultos[bultoSeleccionado][window.piezaSeleccionadaEnBulto];
            window.piezasDisponibles.push(pieza);
            window.configuracionBultos[bultoSeleccionado].splice(window.piezaSeleccionadaEnBulto, 1);
            
            // Actualizar vistas
            mostrarPiezasDisponibles();
            mostrarContenidoBulto();
            
            // Limpiar selección
            window.piezaSeleccionadaEnBulto = null;
        }

        function lanzarTar(pedidoId) {
            document.getElementById('modal-lanzar-tar').style.display = 'block';
            document.getElementById('lanzar-tar-pedido-id').value = pedidoId;
            document.getElementById('lanzar_tar_numero').value = `TAR-${pedidoId}`;
            document.getElementById('lanzar_tar_email').value = 'logistica@empresa.com';
            document.getElementById('lanzar_tar_fecha').value = obtenerFechaHoy();
        }

        function enviarEtiquetas(pedidoId) {
            document.getElementById('modal-enviar-etiquetas').style.display = 'block';
            document.getElementById('enviar-etiquetas-pedido-id').value = pedidoId;
            document.getElementById('enviar_etiquetas_fecha').value = obtenerFechaHoy();
        }

        function eliminarPedido(pedidoId) {
            if (confirm('¿Está seguro de que desea eliminar este pedido? Esta acción no se puede deshacer.')) {
                pedidos = pedidos.filter(p => p.id !== pedidoId);
                guardarDatos();
                mostrarPedidos();
            }
        }

        // Funciones para manejo de PDFs
        function getFileData(pedido, tipo) {
            // Devuelve la URL del archivo almacenado o un placeholder
            switch(tipo) {
                case 'oferta':
                    return pedido.oferta_pdf || '';
                case 'eproc':
                    return ''; // EPROC lanzado no tiene PDF, solo el firmado
                case 'po':
                    return (pedido.eproc_firmado && pedido.eproc_firmado.pdf_url) || '';
                case 'packing':
                    return (pedido.packing_list && pedido.packing_list.pdf_url) || '';
                case 'etiquetas':
                    return (pedido.etiquetas && pedido.etiquetas.pdf_url) || '';
                default:
                    return '';
            }
        }

        function abrirPDF(nombreArchivo, fileData) {
            if (fileData && fileData.startsWith('data:')) {
                // Si es un archivo base64, crear un blob y abrirlo
                const byteCharacters = atob(fileData.split(',')[1]);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], {type: 'application/pdf'});
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
                
                // Limpiar la URL después de un tiempo
                setTimeout(() => URL.revokeObjectURL(url), 10000);
            } else if (fileData) {
                // Si es una URL, abrirla directamente
                window.open(fileData, '_blank');
            } else {
                // Si no hay archivo, mostrar mensaje
                alert('Archivo PDF no disponible. Asegúrese de subir el archivo correspondiente.');
            }
        }

        function procesarArchivoPDF(file) {
            return new Promise((resolve, reject) => {
                if (file && file.type === 'application/pdf') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve(e.target.result); // Devuelve base64
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                } else {
                    reject(new Error('Archivo no válido'));
                }
            });
        }

        // Estados
        function avanzarEstado(pedidoId) {
            if (confirm('¿Está seguro de que desea avanzar al siguiente estado?')) {
                const pedido = pedidos.find(p => p.id === pedidoId);
                const estadoIndex = ESTADOS.indexOf(pedido.estado);
                
                if (estadoIndex < ESTADOS.length - 1) {
                    pedido.estado = ESTADOS[estadoIndex + 1];
                    guardarDatos();
                    mostrarPedidos();
                }
            }
        }

        function retrocederEstado(pedidoId) {
            if (confirm('¿Está seguro de que desea retroceder al estado anterior?')) {
                const pedido = pedidos.find(p => p.id === pedidoId);
                const estadoIndex = ESTADOS.indexOf(pedido.estado);
                
                if (estadoIndex > 0) {
                    pedido.estado = ESTADOS[estadoIndex - 1];
                    guardarDatos();
                    mostrarPedidos();
                }
            }
        }

        // Form handlers
        document.getElementById('form-crear-pedido').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const grid = document.getElementById('pieces-grid');
            const piezas = [];
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseInt(row.children[3].value);
                const precio = parseFloat(row.children[4].value);
                
                piezas.push({
                    referencia: row.children[0].value,
                    descripcion: row.children[1].value,
                    proyecto: row.children[2].value,
                    cantidad: cantidad,
                    precio_unitario: precio,
                    precio_total: cantidad * precio
                });
                
                total += cantidad * precio;
            }
            
            // Procesar el PDF de la oferta
            const file = formData.get('oferta_pdf');
            let pdfUrl = '';
            
            if (file && file.size > 0) {
                try {
                    pdfUrl = await procesarArchivoPDF(file);
                } catch (error) {
                    alert('Error al procesar el archivo PDF');
                    return;
                }
            }
            
            const nuevoPedido = {
                id: nextId++,
                numero_oferta: formData.get('numero_oferta'),
                proveedor: formData.get('proveedor'),
                email_proveedor: formData.get('email_proveedor'),
                fecha_oferta: formData.get('fecha_oferta'),
                fecha_creacion: new Date().toLocaleDateString(),
                estado: 'oferta_recibida',
                piezas: piezas,
                total: total,
                oferta_pdf: pdfUrl
            };
            
            pedidos.push(nuevoPedido);
            guardarDatos();
            mostrarPedidos();
            cerrarModal();
        });

        // Nuevos form handlers
        document.getElementById('form-lanzar-eproc').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('lanzar-eproc-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                pedido.eproc = {
                    numero: formData.get('numero'),
                    oi: formData.get('oi'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'eproc_lanzado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalLanzarEproc();
            }
        });

        document.getElementById('form-firmar-eproc').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('firmar-eproc-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const file = formData.get('pdf');
                let pdfUrl = '';
                
                if (file && file.size > 0) {
                    try {
                        pdfUrl = await procesarArchivoPDF(file);
                    } catch (error) {
                        alert('Error al procesar el archivo PDF');
                        return;
                    }
                }
                
                pedido.eproc_firmado = {
                    pdf: file ? file.name : 'PO_signed.pdf',
                    pdf_url: pdfUrl,
                    po: formData.get('po'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'eproc_firmado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalFirmarEproc();
            }
        });

        document.getElementById('form-packing-list').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('packing-list-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const file = formData.get('pdf');
                let pdfUrl = '';
                
                if (file && file.size > 0) {
                    try {
                        pdfUrl = await procesarArchivoPDF(file);
                    } catch (error) {
                        alert('Error al procesar el archivo PDF');
                        return;
                    }
                }
                
                const numBultos = parseInt(formData.get('bultos'));
                
                // Usar la configuración de bultos global si existe
                let configuracionBultos = {};
                let infoBultos = {};
                
                if (window.configuracionBultos) {
                    configuracionBultos = window.configuracionBultos;
                    infoBultos = window.infoBultos || {};
                } else {
                    // Fallback: crear configuración vacía
                    for (let i = 1; i <= numBultos; i++) {
                        configuracionBultos[`bulto_${i}`] = [];
                        infoBultos[`bulto_${i}`] = { peso: 0, dimensiones: '' };
                    }
                }
                
                pedido.packing_list = {
                    pdf: file ? file.name : 'packinglist.pdf',
                    pdf_url: pdfUrl,
                    direccion: formData.get('direccion'),
                    bultos: numBultos,
                    fecha: formData.get('fecha'),
                    peso_total: parseFloat(formData.get('peso_total')) || 0
                };
                
                // Guardar configuración de bultos e información adicional
                pedido.configuracion_bultos = configuracionBultos;
                pedido.info_bultos = infoBultos;
                pedido.estado = 'packing_list_creado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalPackingList();
                
                // Limpiar variables globales
                window.configuracionBultos = null;
                window.piezasDisponibles = null;
                window.infoBultos = null;
            }
        });

        document.getElementById('form-lanzar-tar').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('lanzar-tar-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                pedido.tar = {
                    numero: formData.get('numero'),
                    email: formData.get('email'),
                    url: formData.get('url'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'tar_lanzado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalLanzarTar();
            }
        });

        document.getElementById('form-enviar-etiquetas').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('enviar-etiquetas-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const file = formData.get('pdf');
                let pdfUrl = '';
                
                if (file && file.size > 0) {
                    try {
                        pdfUrl = await procesarArchivoPDF(file);
                    } catch (error) {
                        alert('Error al procesar el archivo PDF');
                        return;
                    }
                }
                
                pedido.etiquetas = {
                    pdf: file ? file.name : 'etiquetas.pdf',
                    pdf_url: pdfUrl,
                    tracking: formData.get('tracking'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'etiquetas_enviadas';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalEnviarEtiquetas();
            }
        });

        // Cerrar modals al hacer click fuera
        window.onclick = function(event) {
            const modals = [
                'modal-crear-pedido',
                'modal-lanzar-eproc', 
                'modal-firmar-eproc',
                'modal-packing-list',
                'modal-lanzar-tar',
                'modal-enviar-etiquetas',
                'modal-detalle-completo'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html><!-- Cache Buster: 20250804100120 -->

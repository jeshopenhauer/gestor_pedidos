<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📦 Gestor de Pedidos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8fafc;
            color: #374151;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;  /* Aumentado de 1200px */
            margin: 0 auto;
            padding: 30px;      /* Aumentado de 20px */
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 25px;      /* Aumentado de 20px */
            border-radius: 12px; /* Aumentado de 8px */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); /* Mejorado */
        }

        .header h1 {
            color: #0062ff;
            font-size: 2rem;
            margin: 0;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .pedido-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;    /* Aumentado de 8px */
            padding: 25px;          /* Aumentado de 20px */
            margin-bottom: 25px;    /* Aumentado de 20px */
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Añadido */
        }

        .pedido-card.completado {
            background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%);
            border-color: #86efac;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15);
        }

        .pedido-card.completado .pedido-info h3 {
            color: #14532d;
        }

        .pedido-card.completado .pedido-info p {
            color: #166534;
        }

        .pedido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;    /* Aumentado de 15px */
        }

        .pedido-info h3 {
            color: #1f2937;
            margin: 0;
            font-size: 1.4rem;      /* Aumentado de 1.2rem */
        }

        .pedido-info p {
            color: #6b7280;
            margin: 5px 0 0 0;
            font-size: 14px;
        }

        .pedido-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-icon {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn-icon:hover {
            background: #e5e7eb;
        }

        .timeline {
            position: relative;
            display: flex;
            align-items: center;
            margin: 25px 0;      /* Aumentado de 20px */
            padding: 0 25px;     /* Aumentado de 20px */
            min-height: 80px;    /* Añadido */
        }

        .timeline-line {
            position: absolute;
            top: 50%;
            left: 25px;          /* Aumentado de 20px */
            right: 25px;         /* Aumentado de 20px */
            height: 3px;         /* Aumentado de 2px */
            background: #e5e7eb;
            z-index: 1;
        }

        .timeline-step {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            padding: 0 8px;      /* Añadido */
        }

        .timeline-circle {
            width: 45px;         /* Aumentado de 40px */
            height: 45px;        /* Aumentado de 40px */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;     /* Aumentado de 14px */
            background: #e5e7eb;
            color: #6b7280;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Añadido */
        }

        .timeline-circle.active {
            background: #10b981;
            color: white;
            transform: scale(1.1); /* Añadido */
        }

        .timeline-circle.active-blue {
            background: #0062ff;
            color: white;
            transform: scale(1.1);
        }

        .timeline-label {
            margin-top: 10px;    /* Aumentado de 8px */
            font-size: 13px;     /* Aumentado de 12px */
            text-align: center;
            color: #6b7280;
            font-weight: 500;    /* Añadido */
        }

        .timeline-label.active {
            color: #10b981;
            font-weight: 600;
        }

        .timeline-label.active-blue {
            color: #0062ff;
            font-weight: 600;
        }

        .navigation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .detalles-panel {
            border-top: 1px solid #e5e7eb;
            padding-top: 20px;
            margin-top: 20px;
            display: none;
        }

        .detalles-panel.show {
            display: block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-section h5 {
            color: #6b7280;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .pdf-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .pdf-tag {
            background: #f3f4f6;
            color: #374151;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #d1d5db;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .pdf-tag:hover {
            background: #e5e7eb;
            border-color: #9ca3af;
            transform: translateY(-1px);
        }

        .pdf-tag.clickable {
            background: #dbeafe;
            border-color: #93c5fd;
            color: #1d4ed8;
        }

        .pdf-tag.clickable:hover {
            background: #bfdbfe;
            border-color: #60a5fa;
        }

        .notas-container {
            margin-top: 10px;
        }

        .nota-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #3b82f6;
        }

        .nota-fecha {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .nota-texto {
            font-size: 13px;
            color: #374151;
            line-height: 1.4;
        }

        .sin-notas {
            color: #9ca3af;
            font-style: italic;
            font-size: 13px;
            margin: 0;
        }

        .nota-eliminar:hover {
            background: #fca5a5 !important;
            border-color: #f87171 !important;
            transform: scale(1.1);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .pieces-container {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            background: #f9fafb;
            min-height: 350px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        #pieces-grid {
            min-width: 1095px; /* Asegurar ancho mínimo para el grid */
        }

        .piece-row {
            display: grid;
            grid-template-columns: 180px 280px 160px 120px 140px 120px 80px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 20px;
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            border: 1px solid #f3f4f6;
        }

        .piece-row input {
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s ease;
        }

        .piece-row input[type="number"] {
            text-align: center;
            font-weight: 600;
            font-size: 14px;
        }

        .piece-row input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .total-row {
            text-align: right;
            font-weight: bold;
            font-size: 16px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e5e7eb;
            color: #059669;
        }

        .hidden {
            display: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 12px;
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        /* Estilos específicos para Short Description Generator */
        .form-grid-sd {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group-sd {
            margin-bottom: 20px;
        }

        .form-group-sd label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .label-icon-sd {
            color: #0062ff;
            margin-right: 8px;
        }

        .input-row-sd {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-row-sd input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            background: white;
            color: #374151;
        }

        .input-row-sd input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .generate-section-sd {
            text-align: center;
            margin: 30px 0;
            padding: 20px 0;
            border-top: 1px solid #e5e7eb;
        }

        .result-section-sd {
            margin-top: 30px;
        }

        .result-label-sd {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .result-row-sd {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .result-row-sd textarea {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: #f9fafb;
            color: #374151;
            resize: none;
            height: 80px;
            transition: border-color 0.2s ease;
        }

        .result-row-sd textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: white;
        }

        .success-message-sd {
            background: #dcfce7;
            color: #166534;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
            margin-top: 10px;
            border: 1px solid #bbf7d0;
        }

        /* Estilos específicos para TAR */
        #tar-pieces-grid {
            min-width: 1095px;
        }

        .tar-header {
            background: linear-gradient(135deg, #0062ff 0%, #3b82f6 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 20px -20px;
        }

        .tar-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .tar-status.creado {
            background: #fef3c7;
            color: #92400e;
        }

        .tar-status.packing_list_generado {
            background: #dbeafe;
            color: #1e40af;
        }

        .tar-status.tar_lanzado {
            background: #dcfce7;
            color: #166534;
        }

        .tar-status.completado {
            background: #d1fae5;
            color: #065f46;
        }

        /* Botón TAR discreto */
        .tar-floating-button {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: rgba(107, 114, 128, 0.7);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            opacity: 0.8;
        }

        .tar-floating-button:hover {
            background: rgba(107, 114, 128, 0.9);
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        /* Botón DHL discreto */
        .dhl-floating-button {
            position: fixed;
            right: 20px;
            bottom: 60px;
            background: rgba(255, 107, 0, 0.7);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            opacity: 0.8;
        }

        .dhl-floating-button:hover {
            background: rgba(255, 107, 0, 0.9);
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        /* Botón Short Description discreto */
        .sd-floating-button {
            position: fixed;
            right: 20px;
            bottom: 100px;
            background: rgba(59, 130, 246, 0.7);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            opacity: 0.8;
        }

        .sd-floating-button:hover {
            background: rgba(59, 130, 246, 0.9);
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        /* Botón EPROC discreto */
        .eproc-floating-button {
            position: fixed;
            right: 20px;
            bottom: 140px;
            background: rgba(34, 197, 94, 0.7);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 999;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            opacity: 0.8;
        }

        .eproc-floating-button:hover {
            background: rgba(34, 197, 94, 0.9);
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>📦 Gestor de pedidos</h1>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="btn" onclick="abrirModalCrearPedido()">+ Crear pedido</button>
                <button class="btn" onclick="abrirModalCrearTar()" style="background: #0062ff;">+ Crear TAR</button>
            </div>
        </div>

        <!-- Panel de pedidos -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #1f2937; font-size: 1.5rem; margin: 0;">📦 Panel de Pedidos</h2>
                <button class="btn btn-secondary" onclick="abrirInputCargarPedidos('pedidos')" 
                        style="background: #7c3aed; color: white; border-color: #7c3aed;" 
                        title="Cargar pedidos desde archivo JSON">
                    📤 Cargar Pedidos
                </button>
            </div>
            
            <div id="pedidos-container">
                <!-- Aquí se mostrarán los pedidos dinámicamente -->
            </div>

            <!-- Estado vacío pedidos -->
            <div id="empty-state-pedidos" class="empty-state">
                <div class="icon">📋</div>
                <p style="font-size: 18px; margin-bottom: 15px;">No hay pedidos registrados</p>
                <p style="margin-bottom: 20px;">Comience creando su primer pedido</p>
                <button class="btn" onclick="abrirModalCrearPedido()">+ Crear primer pedido</button>
            </div>
        </div>

        <!-- Panel de TAR -->
        <div class="card" style="margin-top: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #1f2937; font-size: 1.5rem; margin: 0;">🚚 Panel de TAR</h2>
                <button class="btn btn-secondary" onclick="abrirInputCargarPedidos('tar')" 
                        style="background: #7c3aed; color: white; border-color: #7c3aed;" 
                        title="Cargar TAR desde archivo JSON">
                    📤 Cargar TAR
                </button>
            </div>
            
            <div id="tar-container">
                <!-- Aquí se mostrarán los TAR dinámicamente -->
            </div>

            <!-- Estado vacío TAR -->
            <div id="empty-state-tar" class="empty-state">
                <div class="icon">🚚</div>
                <p style="font-size: 18px; margin-bottom: 15px;">No hay TAR registrados</p>
                <p style="margin-bottom: 20px;">Comience creando su primer TAR</p>
                <button class="btn" onclick="abrirModalCrearTar()" style="background: #0062ff;">+ Crear primer TAR</button>
            </div>
        </div>
    </div>

    <!-- Botones flotantes laterales -->
    <button class="tar-floating-button" onclick="abrirFormularioTarExterno()">
        TAR
    </button>
    
    <button class="dhl-floating-button" onclick="abrirModalSeguimiento()">
        DHL
    </button>

    <button class="sd-floating-button" onclick="abrirShortDescriptionGenerator()">
        SD
    </button>

    <button class="eproc-floating-button" onclick="abrirEproc()">
        EPROC
    </button>

    <!-- Inputs ocultos para cargar archivos -->
    <input type="file" id="input-cargar-pedidos" accept=".json" multiple
           style="display: none;" onchange="cargarPedidos(this, 'pedidos')">
    <input type="file" id="input-cargar-tar" accept=".json" multiple
           style="display: none;" onchange="cargarPedidos(this, 'tar')">

    <!-- Modal para crear pedido -->
    <div id="modal-crear-pedido" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Crear Nuevo Pedido</h2>
                <span class="close" onclick="cerrarModal()">&times;</span>
            </div>
            
            <form id="form-crear-pedido">
                <div class="form-group">
                    <label for="numero_oferta">Número de Oferta</label>
                    <input type="text" id="numero_oferta" name="numero_oferta">
                </div>

                <div class="form-group">
                    <label for="proveedor">Proveedor</label>
                    <input type="text" id="proveedor" name="proveedor">
                </div>

                <div class="form-group">
                    <label for="email_proveedor">Email Proveedor</label>
                    <input type="text" id="email_proveedor" name="email_proveedor">
                </div>

                <div class="form-group">
                    <label for="fecha_oferta">Fecha de la Oferta</label>
                    <input type="date" id="fecha_oferta" name="fecha_oferta">
                </div>

                <div class="form-group">
                    <label for="oferta_pdf">PDF de la Oferta</label>
                    <input type="file" id="oferta_pdf" name="oferta_pdf" accept=".pdf">
                </div>

                <div class="pieces-container">
                    <h3 style="margin-bottom: 20px; color: #374151;">Piezas del Pedido</h3>
                    <div id="pieces-grid">
                        <div class="piece-row" style="background: #374151; color: white; font-weight: bold; border-radius: 8px;">
                            <div style="padding: 12px 15px;">Referencia</div>
                            <div style="padding: 12px 15px;">Descripción</div>
                            <div style="padding: 12px 15px;">Proyecto</div>
                            <div style="padding: 12px 15px;">Cantidad</div>
                            <div style="padding: 12px 15px;">Precio Unit. (€)</div>
                            <div style="padding: 12px 15px;">Total Fila (€)</div>
                            <div style="padding: 12px 15px;">Acción</div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="agregarPieza()" style="margin-top: 15px;">+ Agregar Pieza</button>
                    <div class="total-row">
                        Total: €<span id="total-pedido">0.000</span>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModal()">Cancelar</button>
                    <button type="submit" class="btn">Crear Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para lanzar Eproc -->
    <div id="modal-lanzar-eproc" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lanzar Eproc</h2>
                <span class="close" onclick="cerrarModalLanzarEproc()">&times;</span>
            </div>
            
            <form id="form-lanzar-eproc">
                <input type="hidden" id="lanzar-eproc-pedido-id">
                
                <div class="form-group">
                    <label for="lanzar_eproc_numero">Número Eproc</label>
                    <input type="text" id="lanzar_eproc_numero" name="numero">
                </div>

                <div class="form-group">
                    <label for="lanzar_eproc_oi">OI</label>
                    <input type="text" id="lanzar_eproc_oi" name="oi">
                </div>

                <div class="form-group">
                    <label for="lanzar_eproc_short_description">Short Description</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <textarea id="lanzar_eproc_short_description" name="short_description" rows="3" style="flex: 1; resize: vertical; font-family: inherit; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ingrese la descripción corta del EPROC"></textarea>
                        <button type="button" class="btn btn-secondary" onclick="abrirShortDescriptionGenerator()" style="padding: 10px 15px; white-space: nowrap;" title="Abrir generador de descripción corta">
                            📝 Generator
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="lanzar_eproc_fecha">Fecha</label>
                    <input type="date" id="lanzar_eproc_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalLanzarEproc()">Cancelar</button>
                    <button type="submit" class="btn">Lanzar Eproc</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para firmar Eproc -->
    <div id="modal-firmar-eproc" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Firmar Eproc</h2>
                <span class="close" onclick="cerrarModalFirmarEproc()">&times;</span>
            </div>
            
            <form id="form-firmar-eproc">
                <input type="hidden" id="firmar-eproc-pedido-id">
                
                <div class="form-group">
                    <label for="firmar_eproc_pdf">PDF de la PO</label>
                    <input type="file" id="firmar_eproc_pdf" name="pdf" accept=".pdf">
                </div>

                <div class="form-group">
                    <label for="firmar_eproc_po">Número PO</label>
                    <input type="text" id="firmar_eproc_po" name="po">
                </div>

                <div class="form-group">
                    <label for="firmar_eproc_fecha">Fecha</label>
                    <input type="date" id="firmar_eproc_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalFirmarEproc()">Cancelar</button>
                    <button type="submit" class="btn">Firmar Eproc</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para crear Packing List -->
    <div id="modal-packing-list" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Crear Packing List</h2>
                <span class="close" onclick="cerrarModalPackingList()">&times;</span>
            </div>
            
            <form id="form-packing-list">
                <input type="hidden" id="packing-list-pedido-id">
                
                <div class="form-group">
                    <label for="packing_list_pdf">PDF del Packing List</label>
                    <input type="file" id="packing_list_pdf" name="pdf" accept=".pdf">
                </div>

                <div class="form-group">
                    <label for="packing_list_bultos">Número de bultos</label>
                    <input type="number" id="packing_list_bultos" name="bultos" min="1" onchange="generarConfiguracionBultos()">
                </div>

                <div class="form-group">
                    <label for="packing_list_fecha">Fecha</label>
                    <input type="date" id="packing_list_fecha" name="fecha">
                </div>

                <div class="form-group">
                    <label for="packing_list_peso_total">Peso Total (kg)</label>
                    <input type="number" id="packing_list_peso_total" name="peso_total" step="0.1" min="0" placeholder="0.0">
                </div>

                <!-- Configuración de bultos -->
                <div id="configuracion-bultos-container" style="margin-top: 20px; display: none;">
                    <h3 style="color: #374151; margin-bottom: 15px;">Configuración de Bultos</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">Asigne las piezas a cada bulto:</p>
                    
                    <div style="display: flex; gap: 20px; align-items: flex-start;">
                        <!-- Lista de piezas disponibles -->
                        <div style="flex: 1; min-width: 250px;">
                            <h4 style="margin-bottom: 10px; color: #374151;">Piezas Disponibles</h4>
                            <div id="piezas-disponibles" style="
                                border: 2px solid #d1d5db; 
                                border-radius: 8px; 
                                padding: 15px; 
                                background: #f9fafb;
                                min-height: 300px;
                                max-height: 400px;
                                overflow-y: auto;
                            ">
                                <!-- Se llenará dinámicamente -->
                            </div>
                        </div>
                        
                        <!-- Botones de control -->
                        <div style="display: flex; flex-direction: column; gap: 10px; padding-top: 40px;">
                            <button type="button" onclick="moverPiezaABulto()" style="
                                padding: 10px 15px;
                                border: 2px solid #374151;
                                background: #374151;
                                color: white;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">→</button>
                            <button type="button" onclick="regresarPiezaADisponibles()" style="
                                padding: 10px 15px;
                                border: 2px solid #374151;
                                background: white;
                                color: #374151;
                                border-radius: 6px;
                                cursor: pointer;
                                font-weight: bold;
                            ">←</button>
                        </div>
                        
                        <!-- Bultos -->
                        <div style="flex: 2; min-width: 300px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #374151;">Bultos</h4>
                                <select id="bulto-selector" style="
                                    padding: 5px 10px;
                                    border: 2px solid #d1d5db;
                                    border-radius: 6px;
                                    background: white;
                                ">
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            
                            <!-- Información del bulto seleccionado -->
                            <div id="info-bulto-container" style="margin-bottom: 15px; display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; background: #f3f4f6; border-radius: 6px; margin-bottom: 10px;">
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block;">Peso (kg)</label>
                                        <input type="number" id="bulto-peso" step="0.1" min="0" placeholder="0.0" style="
                                            width: 100%; 
                                            padding: 5px; 
                                            border: 1px solid #d1d5db; 
                                            border-radius: 4px;
                                            font-size: 14px;
                                        " onchange="actualizarInfoBulto()">
                                    </div>
                                    <div>
                                        <label style="font-size: 12px; color: #6b7280; display: block;">Dimensiones (cm)</label>
                                        <input type="text" id="bulto-dimensiones" placeholder="L x W x H" style="
                                            width: 100%; 
                                            padding: 5px; 
                                            border: 1px solid #d1d5db; 
                                            border-radius: 4px;
                                            font-size: 14px;
                                        " onchange="actualizarInfoBulto()">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="bulto-contenido" style="
                                border: 2px solid #d1d5db; 
                                border-radius: 8px; 
                                padding: 15px; 
                                background: white;
                                min-height: 300px;
                                max-height: 400px;
                                overflow-y: auto;
                            ">
                                <p style="color: #9ca3af; text-align: center; margin-top: 50px;">
                                    Seleccione un bulto y use los botones para asignar piezas
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalPackingList()">Cancelar</button>
                    <button type="submit" class="btn">Crear Packing List</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para lanzar TAR -->
    <div id="modal-lanzar-tar" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Lanzar TAR</h2>
                <span class="close" onclick="cerrarModalLanzarTar()">&times;</span>
            </div>
            
            <form id="form-lanzar-tar">
                <input type="hidden" id="lanzar-tar-pedido-id">
                
                <div class="form-group">
                    <label for="lanzar_tar_numero">Número TAR</label>
                    <input type="text" id="lanzar_tar_numero" name="numero">
                </div>

                <div class="form-group">
                    <label for="lanzar_tar_email">Email Logística</label>
                    <input type="text" id="lanzar_tar_email" name="email">
                </div>

                <div class="form-group">
                    <label for="lanzar_tar_url">URL</label>
                    <input type="url" id="lanzar_tar_url" name="url">
                </div>

                <div class="form-group">
                    <label for="lanzar_tar_fecha">Fecha</label>
                    <input type="date" id="lanzar_tar_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalLanzarTar()">Cancelar</button>
                    <button type="submit" class="btn">Lanzar TAR</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para enviar etiquetas -->
    <div id="modal-enviar-etiquetas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Enviar Etiquetas</h2>
                <span class="close" onclick="cerrarModalEnviarEtiquetas()">&times;</span>
            </div>
            
            <form id="form-enviar-etiquetas">
                <input type="hidden" id="enviar-etiquetas-pedido-id">
                
                <div class="form-group">
                    <label for="enviar_etiquetas_pdf">PDF de las etiquetas</label>
                    <input type="file" id="enviar_etiquetas_pdf" name="pdf" accept=".pdf">
                </div>

                <div class="form-group">
                    <label for="enviar_etiquetas_tracking">Número de tracking</label>
                    <input type="text" id="enviar_etiquetas_tracking" name="tracking">
                </div>

                <div class="form-group">
                    <label for="enviar_etiquetas_direccion_envio">Dirección de recogida</label>
                    <textarea id="enviar_etiquetas_direccion_envio" name="direccion_envio" rows="3" placeholder="Dirección completa desde donde recoger el paquete"></textarea>
                </div>

                <div class="form-group">
                    <label for="enviar_etiquetas_fecha">Fecha</label>
                    <input type="date" id="enviar_etiquetas_fecha" name="fecha">
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalEnviarEtiquetas()">Cancelar</button>
                    <button type="submit" class="btn">Enviar Etiquetas</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para ver detalles completos -->
    <div id="modal-detalle-completo" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="detalle-titulo">Detalles del Pedido</h2>
                <span class="close" onclick="cerrarModalDetalle()">&times;</span>
            </div>
            
            <div id="detalle-contenido" style="max-height: 70vh; overflow-y: auto;">
                <!-- Se llenará dinámicamente -->
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalDetalle()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Short Description Generator -->
    <div id="modal-short-description" class="modal">
        <div class="modal-content" style="max-width: 850px; max-height: 90vh;">
            <div class="modal-header">
                <h2 style="color: #0062ff; margin: 0; font-size: 1.8rem;">Short Description Generator</h2>
                <span class="close" onclick="cerrarModalShortDescription()">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                <div class="form-grid-sd">
                    <div class="form-group-sd">
                        <label for="sd-oferta">
                            <span class="label-icon-sd"></span>Nº OFERTA
                        </label>
                        <div class="input-row-sd">
                            <input type="text" id="sd-oferta">
                            <button class="btn btn-secondary" onclick="pegarSD('sd-oferta')">Pegar</button>
                        </div>
                    </div>

                    <div class="form-group-sd">
                        <label for="sd-pieza">
                            <span class="label-icon-sd"></span>PIEZA
                        </label>
                        <div class="input-row-sd">
                            <input type="text" id="sd-pieza">
                            <button class="btn btn-secondary" onclick="pegarSD('sd-pieza')">Pegar</button>
                        </div>
                    </div>

                    <div class="form-group-sd">
                        <label for="sd-descripcion">
                            <span class="label-icon-sd"></span>DESCRIPCIÓN
                        </label>
                        <div class="input-row-sd">
                            <input type="text" id="sd-descripcion">
                            <button class="btn btn-secondary" onclick="pegarSD('sd-descripcion')">Pegar</button>
                        </div>
                    </div>

                    <div class="form-group-sd">
                        <label for="sd-proyecto">
                            <span class="label-icon-sd"></span>PROYECTO
                        </label>
                        <div class="input-row-sd">
                            <input type="text" id="sd-proyecto">
                            <button class="btn btn-secondary" onclick="pegarSD('sd-proyecto')">Pegar</button>
                        </div>
                    </div>

                    <div class="form-group-sd">
                        <label for="sd-precio">
                            <span class="label-icon-sd"></span>PRECIO UNITARIO
                        </label>
                        <div class="input-row-sd">
                            <input type="text" id="sd-precio">
                            <button class="btn btn-secondary" onclick="pegarSD('sd-precio')">Pegar</button>
                        </div>
                    </div>
                </div>

                <div class="generate-section-sd">
                    <button class="btn" onclick="generarDescripcionSD()" style="background: #10b981; padding: 12px 24px; font-size: 16px; font-weight: 600;">
                        Generar Descripción
                    </button>
                </div>

                <div class="result-section-sd">
                    <label class="result-label-sd">
                        <span class="label-icon-sd"></span>Resultado Generado
                    </label>
                    <div class="result-row-sd">
                        <textarea id="sd-resultado" readonly style="font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; height: 80px; background: #f9fafb;"></textarea>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <button class="btn" onclick="copiarAlPortapapelesSD()" style="height: fit-content;">
                                Copiar
                            </button>
                            <button class="btn btn-secondary" onclick="transferirAEproc()" style="height: fit-content; font-size: 12px; padding: 5px 10px;" title="Transferir a campo EPROC">
                                📋 A EPROC
                            </button>
                        </div>
                    </div>
                    <div class="success-message-sd" id="sd-success-message">
                        ¡Copiado al portapapeles exitosamente!
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px; padding: 0 20px 20px 20px;">
                <button type="button" class="btn btn-secondary" onclick="limpiarCamposSD()">Limpiar</button>
                <button type="button" class="btn btn-secondary" onclick="cerrarModalShortDescription()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para crear TAR -->
    <div id="modal-crear-tar" class="modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>🚚 Crear Nuevo TAR</h2>
                <span class="close" onclick="cerrarModalCrearTar()">&times;</span>
            </div>
            
            <form id="form-crear-tar">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tar_proveedor">Proveedor</label>
                        <input type="text" id="tar_proveedor" name="proveedor">
                    </div>

                    <div class="form-group">
                        <label for="tar_email_proveedor">Email del Proveedor</label>
                        <input type="text" id="tar_email_proveedor" name="email_proveedor">
                    </div>

                    <div class="form-group">
                        <label for="tar_numero_oferta">Número de Oferta</label>
                        <input type="text" id="tar_numero_oferta" name="numero_oferta">
                    </div>

                    <div class="form-group">
                        <label for="tar_fecha_oferta">Fecha de Oferta</label>
                        <input type="date" id="tar_fecha_oferta" name="fecha_oferta">
                    </div>

                    <div class="form-group">
                        <label for="tar_numero_eproc">Número EPROC</label>
                        <input type="text" id="tar_numero_eproc" name="numero_eproc">
                    </div>

                    <div class="form-group">
                        <label for="tar_oi_eproc">OI (Opcional)</label>
                        <input type="text" id="tar_oi_eproc" name="oi_eproc">
                    </div>

                    <div class="form-group">
                        <label for="tar_oferta_pdf">Subir PDF de Oferta</label>
                        <input type="file" id="tar_oferta_pdf" name="oferta_pdf" accept=".pdf">
                    </div>
                </div>

                <!-- Sección de piezas -->
                <div class="pieces-container">
                    <h3 style="margin-bottom: 20px; color: #374151;">Piezas del TAR</h3>
                    <div id="tar-pieces-grid">
                        <div class="piece-row" style="font-weight: bold; background: #f3f4f6;">
                            <div style="padding: 12px 15px;">Referencia</div>
                            <div style="padding: 12px 15px;">Descripción</div>
                            <div style="padding: 12px 15px;">Proyecto</div>
                            <div style="padding: 12px 15px;">Cantidad</div>
                            <div style="padding: 12px 15px;">Precio Unit. (€)</div>
                            <div style="padding: 12px 15px;">Total Fila (€)</div>
                            <div style="padding: 12px 15px;">Acción</div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="agregarPiezaTar()" style="margin-top: 15px;">+ Agregar Pieza</button>
                    <div class="total-row">
                        Total: €<span id="total-tar">0.000</span>
                    </div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalCrearTar()">Cancelar</button>
                    <button type="submit" class="btn">Crear TAR</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Seguimiento DHL -->
    <div id="modal-seguimiento-dhl" class="modal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh;">
            <div class="modal-header">
                <h2>🚚 Seguimiento DHL API</h2>
                <span class="close" onclick="cerrarModalSeguimiento()">&times;</span>
            </div>
            
            <div style="max-height: 70vh; overflow-y: auto; padding: 20px;">
                <!-- Sección de entrada de tracking -->
                <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="color: #374151; margin-bottom: 15px;">📋 Consultar Seguimiento</h3>
                    <div style="display: flex; gap: 15px; align-items: end;">
                        <div style="flex: 1;">
                            <label for="tracking-input" style="display: block; margin-bottom: 5px; font-weight: 500; color: #374151;">
                                Número de Tracking DHL
                            </label>
                            <input type="text" id="tracking-input" placeholder="Ej: 1234567890 o JD001234567890" 
                                   style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;">
                        </div>
                        <button onclick="consultarAPIDHL()" class="btn" 
                                style="background: #ff6b00; border-color: #ff6b00; padding: 10px 20px;">
                            🔍 Consultar API
                        </button>
                    </div>
                    <p style="color: #059669; font-size: 12px; margin-top: 10px;">
                        � <strong>API Configurada:</strong> Conectado a DHL Unified Tracking API para datos en tiempo real.
                        <br>Estado: <span style="color: green; font-weight: bold;">✅ Producción</span>
                    </p>
                </div>

                <!-- Contenedor para mostrar resultados -->
                <div id="dhl-frame-container" style="display: none;">
                    <!-- Aquí se mostrarán los resultados de la API -->
                </div>

                <!-- Mensaje de instrucciones inicial -->
                <div id="instrucciones-iniciales" style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">�</div>
                    <h3 style="color: #374151; margin-bottom: 15px;">Consulta el estado de tus paquetes con la API de DHL</h3>
                    <p style="color: #6b7280; line-height: 1.6; margin-bottom: 20px;">
                        Este sistema utiliza la API oficial de DHL para obtener información actualizada 
                        del estado de tus envíos en tiempo real.
                    </p>
                    <div style="margin-top: 30px; padding: 20px; background: #d1fae5; border-left: 4px solid #059669; border-radius: 6px; text-align: left;">
                        <h4 style="color: #047857; margin-bottom: 10px;">✅ Estado de la API:</h4>
                        <ul style="color: #047857; padding-left: 20px; margin: 0;">
                            <li><strong>Estado:</strong> ✅ Configurado para producción</li>
                            <li><strong>API:</strong> DHL Unified Tracking API activa</li>
                            <li><strong>API Key:</strong> Configurada y validada</li>
                            <li><strong>Límites:</strong> 250 consultas/día, 1 consulta/segundo</li>
                        </ul>
                    </div>
                    <div style="margin-top: 20px; padding: 20px; background: #dbeafe; border-left: 4px solid #3b82f6; border-radius: 6px; text-align: left;">
                        <h4 style="color: #1e40af; margin-bottom: 10px;">💡 Consejos de uso:</h4>
                        <ul style="color: #1e40af; padding-left: 20px; margin: 0;">
                            <li>Los números de tracking DHL suelen tener 10-11 dígitos</li>
                            <li>También pueden empezar con letras (ej: JD001234567890)</li>
                            <li>El sistema valida formato básico antes de consultar</li>
                            <li>Manejo inteligente de errores y reintentos</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px; padding: 20px; border-top: 1px solid #e5e7eb;">
                <button type="button" class="btn btn-secondary" onclick="cerrarModalSeguimiento()">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal para añadir nota -->
    <div id="modal-nota" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Añadir Nota</h2>
                <span class="close" onclick="cerrarModalNota()">&times;</span>
            </div>
            
            <form id="form-nota">
                <div class="form-group">
                    <label for="texto-nota">Nota</label>
                    <textarea id="texto-nota" name="texto-nota" rows="4" 
                              placeholder="Escribe tu nota aquí..." 
                              style="width: 100%; min-height: 100px; resize: vertical;"></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="cerrarModalNota()">Cancelar</button>
                    <button type="button" class="btn" onclick="guardarNota()" style="background: #3b82f6; color: white; border-color: #3b82f6;">Guardar Nota</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Datos en memoria
        let pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
        let nextId = parseInt(localStorage.getItem('nextId')) || 1;

        // Estados del workflow (9 estados sin bultos)
        const ESTADOS = [
            'oferta_recibida', 
            'eproc_lanzado', 
            'eproc_firmado', 
            'packing_list_creado', 
            'tar_lanzado', 
            'etiquetas_enviadas', 
            'recibido_planta', 
            'sin_incidencias', 
            'completado'
        ];
        const NOMBRES_ESTADOS = {
            'oferta_recibida': 'Oferta<br>Recibida',
            'eproc_lanzado': 'Eproc<br>Lanzado',
            'eproc_firmado': 'Eproc<br>Firmado',
            'packing_list_creado': 'Packing<br>List',
            'tar_lanzado': 'TAR<br>Lanzado',
            'etiquetas_enviadas': 'Etiquetas<br>Enviadas',
            'recibido_planta': 'Paquete<br>Recogido',
            'sin_incidencias': 'Paquete<br>en Casa',
            'completado': 'Paquete<br>Recogido'
        };

        // Función para obtener nombres de estados sin HTML
        function getNombreEstadoTexto(estado) {
            const nombres = {
                'oferta_recibida': 'Oferta Recibida',
                'eproc_lanzado': 'Eproc Lanzado', 
                'eproc_firmado': 'Eproc Firmado',
                'packing_list_creado': 'Packing List',
                'tar_lanzado': 'TAR Lanzado',
                'etiquetas_enviadas': 'Etiquetas Enviadas',
                'recibido_planta': 'Paquete Recogido',
                'sin_incidencias': 'Paquete en Casa',
                'completado': 'Paquete Recogido'
            };
            return nombres[estado] || estado;
        }

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            mostrarPedidos();
            agregarPieza(); // Agregar una pieza inicial
        });

        // Función para obtener la fecha de hoy en formato YYYY-MM-DD
        function obtenerFechaHoy() {
            const hoy = new Date();
            return hoy.toISOString().split('T')[0];
        }

        // Guardar datos en localStorage
        function guardarDatos() {
            localStorage.setItem('pedidos', JSON.stringify(pedidos));
            localStorage.setItem('nextId', nextId.toString());
        }

        // ===============================
        // FUNCIONES DE BACKUP/RESTORE
        // ===============================
        
        // Función para descargar todos los pedidos como archivo JSON
        function descargarPedidos() {
            try {
                // Crear objeto con todos los datos
                const datosCompletos = {
                    version: "1.0",
                    fechaExportacion: new Date().toISOString(),
                    totalPedidos: pedidos.length,
                    nextId: nextId,
                    pedidos: pedidos
                };

                // Convertir a JSON con formato legible
                const jsonString = JSON.stringify(datosCompletos, null, 2);
                
                // Crear blob y URL para descargar
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Crear enlace temporal para descarga
                const link = document.createElement('a');
                link.href = url;
                
                // Generar nombre de archivo con fecha y hora
                const fecha = new Date();
                const fechaFormateada = fecha.toISOString().slice(0, 19).replace(/:/g, '-');
                link.download = `gestor-pedidos-backup-${fechaFormateada}.json`;
                
                // Ejecutar descarga
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL
                URL.revokeObjectURL(url);
                
                // Mostrar confirmación
                alert(`✅ Descarga completada!\n\n` +
                      `📄 Archivo: gestor-pedidos-backup-${fechaFormateada}.json\n` +
                      `📦 Pedidos exportados: ${pedidos.length}\n` +
                      `📅 Fecha: ${fecha.toLocaleString('es-ES')}\n\n` +
                      `El archivo se ha guardado en tu carpeta de Descargas.`);
                
            } catch (error) {
                console.error('Error al descargar pedidos:', error);
                alert('❌ Error al descargar los pedidos. Revisa la consola para más detalles.');
            }
        }

        // Función para descargar un pedido individual
        function descargarPedidoIndividual(pedidoId) {
            try {
                // Encontrar el pedido específico
                const pedido = pedidos.find(p => p.id === pedidoId);
                
                if (!pedido) {
                    alert('❌ Error: No se encontró el pedido solicitado.');
                    return;
                }

                // Crear objeto con el pedido individual
                const datosCompletos = {
                    version: "1.0",
                    fechaExportacion: new Date().toISOString(),
                    totalPedidos: 1,
                    nextId: nextId,
                    pedidos: [pedido]
                };

                // Convertir a JSON con formato legible
                const jsonString = JSON.stringify(datosCompletos, null, 2);
                
                // Crear blob y URL para descargar
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // Crear enlace temporal para descarga
                const link = document.createElement('a');
                link.href = url;
                
                // Generar nombre de archivo específico
                const fecha = new Date();
                const fechaFormateada = fecha.toISOString().slice(0, 10);
                const tipo = pedido.tipo === 'TAR' ? 'TAR' : 'Pedido';
                
                // Limpiar el nombre del proveedor para el archivo (sin espacios ni caracteres especiales)
                const proveedorLimpio = pedido.proveedor 
                    ? pedido.proveedor.replace(/[^a-zA-Z0-9]/g, '_').toUpperCase()
                    : 'SIN_PROVEEDOR';
                
                link.download = `${tipo}-${pedido.id}-${proveedorLimpio}-${fechaFormateada}.json`;
                
                // Ejecutar descarga
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpiar URL
                URL.revokeObjectURL(url);
                
                // Mostrar confirmación
                alert(`✅ ${tipo} descargado exitosamente!\n\n` +
                      `📄 Archivo: ${link.download}\n` +
                      `📦 ${tipo}: #${pedido.id} - ${pedido.numero_oferta}\n` +
                      `💰 Total: €${pedido.total.toFixed(3)}\n` +
                      `📅 Fecha: ${fecha.toLocaleString('es-ES')}\n\n` +
                      `El archivo se ha guardado en tu carpeta de Descargas.`);
                
            } catch (error) {
                console.error('Error al descargar pedido individual:', error);
                alert('❌ Error al descargar el pedido. Revisa la consola para más detalles.');
            }
        }

        // Función para abrir el input de archivo (carga)
        function abrirInputCargarPedidos(tipo = 'pedidos') {
            if (tipo === 'tar') {
                document.getElementById('input-cargar-tar').click();
            } else {
                document.getElementById('input-cargar-pedidos').click();
            }
        }

        // Función para cargar pedidos desde archivo JSON
        function cargarPedidos(inputElement, tipo = 'pedidos') {
            const archivos = Array.from(inputElement.files);
            
            if (archivos.length === 0) {
                return;
            }

            // Verificar que todos sean archivos JSON
            const archivosInvalidos = archivos.filter(archivo => !archivo.name.toLowerCase().endsWith('.json'));
            if (archivosInvalidos.length > 0) {
                alert(`❌ Error: Solo se permiten archivos JSON (.json)\n\nArchivos inválidos:\n${archivosInvalidos.map(a => a.name).join('\n')}`);
                inputElement.value = '';
                return;
            }

            const tipoTexto = tipo === 'tar' ? 'TAR' : 'Pedidos';
            
            // Mostrar información previa y pedir confirmación
            const totalPedidosActuales = tipo === 'tar' ? 
                pedidos.filter(p => p.tipo === 'TAR').length : 
                pedidos.filter(p => p.tipo !== 'TAR').length;
            
            const mensaje = `📂 CARGAR ${tipoTexto.toUpperCase()} DESDE MÚLTIPLES ARCHIVOS\n\n` +
                          `📄 Archivos seleccionados: ${archivos.length}\n` +
                          `📊 ${tipoTexto} actuales: ${totalPedidosActuales}\n\n` +
                          `Archivos a procesar:\n${archivos.map(a => a.name).join('\n')}\n\n` +
                          `✅ Los nuevos ${tipoTexto.toLowerCase()} se añadirán a los existentes.\n\n` +
                          `¿Deseas continuar?`;
            
            if (!confirm(mensaje)) {
                inputElement.value = '';
                return;
            }

            // Variables para seguimiento del progreso
            let archivosProcessados = 0;
            let totalPedidosImportados = 0;
            let errores = [];
            let maxIdActual = pedidos.length > 0 ? Math.max(...pedidos.map(p => p.id)) : 0;

            // Función para procesar cada archivo
            function procesarArchivo(archivo, index) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const datosImportados = JSON.parse(e.target.result);
                        
                        // Validar estructura del archivo
                        if (!datosImportados.pedidos || !Array.isArray(datosImportados.pedidos)) {
                            throw new Error(`Estructura de archivo inválida: no se encontró array de pedidos`);
                        }

                        // Filtrar según el tipo solicitado
                        let pedidosFiltrados;
                        if (tipo === 'tar') {
                            pedidosFiltrados = datosImportados.pedidos.filter(p => p.tipo === 'TAR');
                        } else {
                            pedidosFiltrados = datosImportados.pedidos.filter(p => p.tipo !== 'TAR');
                        }

                        // Asignar nuevos IDs únicos a los pedidos importados
                        pedidosFiltrados.forEach(pedidoImportado => {
                            maxIdActual++;
                            pedidoImportado.id = maxIdActual;
                            pedidos.push(pedidoImportado);
                        });
                        
                        totalPedidosImportados += pedidosFiltrados.length;
                        
                    } catch (error) {
                        console.error('Error al procesar archivo:', error);
                        errores.push(`${archivo.name}: ${error.message}`);
                    }
                    
                    archivosProcessados++;
                    
                    // Si todos los archivos han sido procesados
                    if (archivosProcessados === archivos.length) {
                        finalizarCarga();
                    }
                };

                reader.onerror = function() {
                    errores.push(`${archivo.name}: Error al leer el archivo`);
                    archivosProcessados++;
                    
                    if (archivosProcessados === archivos.length) {
                        finalizarCarga();
                    }
                };

                // Leer el archivo
                reader.readAsText(archivo);
            }

            function finalizarCarga() {
                // Actualizar nextId para evitar conflictos futuros
                const maxIdFinal = pedidos.length > 0 ? Math.max(...pedidos.map(p => p.id)) : 0;
                nextId = Math.max(nextId, maxIdFinal + 1);

                // Guardar en localStorage
                guardarDatos();
                
                // Actualizar la interfaz
                mostrarPedidos();
                
                // Mostrar resumen de la importación
                const totalFinal = tipo === 'tar' ? 
                    pedidos.filter(p => p.tipo === 'TAR').length : 
                    pedidos.filter(p => p.tipo !== 'TAR').length;
                
                let mensajeFinal = `📊 RESUMEN DE IMPORTACIÓN\n\n` +
                                 `📄 Archivos procesados: ${archivosProcessados}\n` +
                                 `📦 ${tipoTexto} importados: ${totalPedidosImportados}\n` +
                                 `📊 Total ${tipoTexto.toLowerCase()} ahora: ${totalFinal}\n`;
                
                if (errores.length > 0) {
                    mensajeFinal += `\n⚠️ ERRORES ENCONTRADOS:\n${errores.join('\n')}\n`;
                }
                
                if (totalPedidosImportados > 0) {
                    mensajeFinal += `\n✅ Los datos se han guardado automáticamente.`;
                }
                
                alert(mensajeFinal);
                
                // Limpiar el input
                inputElement.value = '';
            }

            // Procesar todos los archivos
            archivos.forEach((archivo, index) => {
                procesarArchivo(archivo, index);
            });
        }

        // Mostrar pedidos
        function mostrarPedidos() {
            const pedidosContainer = document.getElementById('pedidos-container');
            const tarContainer = document.getElementById('tar-container');
            const emptyStatePedidos = document.getElementById('empty-state-pedidos');
            const emptyStateTar = document.getElementById('empty-state-tar');
            
            // Separar pedidos y TAR
            const solosPedidos = pedidos.filter(p => p.tipo !== 'TAR');
            const solosTar = pedidos.filter(p => p.tipo === 'TAR');
            
            // Mostrar pedidos
            if (solosPedidos.length === 0) {
                pedidosContainer.innerHTML = '';
                emptyStatePedidos.style.display = 'block';
            } else {
                emptyStatePedidos.style.display = 'none';
                pedidosContainer.innerHTML = solosPedidos.map(pedido => crearTarjetaPedido(pedido)).join('');
            }
            
            // Mostrar TAR
            if (solosTar.length === 0) {
                tarContainer.innerHTML = '';
                emptyStateTar.style.display = 'block';
            } else {
                emptyStateTar.style.display = 'none';
                tarContainer.innerHTML = solosTar.map(pedido => crearTarjetaPedido(pedido)).join('');
            }
        }

        // Crear tarjeta de pedido
        function crearTarjetaPedido(pedido) {
            const estadoIndex = ESTADOS.indexOf(pedido.estado);
            const esTar = pedido.tipo === 'TAR';
            const claseCompletado = pedido.estado === 'completado' ? ' completado' : '';
            
            return `
                <div class="pedido-card${claseCompletado}" data-pedido-id="${pedido.id}">
                    <div class="pedido-header">
                        <div class="pedido-info">
                            <h3>${esTar ? '🚚 TAR' : 'Pedido'} #${pedido.id}</h3>
                            <p>${pedido.fecha_creacion} - ${pedido.proveedor} - €${pedido.total.toFixed(3)}</p>
                        </div>
                        <div class="pedido-actions">
                            <button class="btn-icon" onclick="toggleDetalles(${pedido.id})" title="Ver más detalles">
                                <span id="toggle-icon-${pedido.id}">▼</span>
                            </button>
                            <button class="btn-icon" onclick="mostrarDetalleCompleto(${pedido.id})" title="Ver detalle completo" style="background: #dbeafe; border-color: #93c5fd; color: #1d4ed8;">
                                👁️
                            </button>
                            <button class="btn-icon" onclick="abrirModalNota(${pedido.id})" title="Añadir nota" style="background: #fef3c7; border-color: #fcd34d; color: #d97706;">
                                📝
                            </button>
                            <button class="btn-icon" onclick="descargarPedidoIndividual(${pedido.id})" title="Descargar este pedido" style="background: #dcfce7; border-color: #bbf7d0; color: #059669;">
                                📥
                            </button>
                            <button class="btn-icon" onclick="eliminarPedido(${pedido.id})" title="Eliminar pedido" style="background: #fee2e2; border-color: #fecaca; color: #dc2626;">
                                🗑️
                            </button>
                        </div>
                    </div>

                    <div class="timeline">
                        <div class="timeline-line"></div>
                        ${ESTADOS.map((estado, index) => {
                            let claseEstado = '';
                            let circuloTexto = '';
                            
                            if (esTar && (estado === 'oferta_recibida' || estado === 'eproc_lanzado' || estado === 'eproc_firmado')) {
                                // Para TAR: primeros tres estados siempre en azul (pre-completados) sin números
                                claseEstado = 'active-blue';
                                circuloTexto = '';
                            } else if (index <= estadoIndex) {
                                // Estados completados normalmente (verde)
                                claseEstado = 'active';
                                circuloTexto = '✓';
                            } else {
                                // Estados pendientes - para TAR el paso 1 empieza en packing_list (índice 3)
                                claseEstado = '';
                                if (esTar) {
                                    circuloTexto = index >= 3 ? (index - 2) : '';
                                } else {
                                    circuloTexto = index + 1;
                                }
                            }
                            
                            return `
                            <div class="timeline-step">
                                <div class="timeline-circle ${claseEstado}">
                                    ${circuloTexto}
                                </div>
                                <span class="timeline-label ${claseEstado}">
                                    ${NOMBRES_ESTADOS[estado]}
                                </span>
                            </div>
                        `}).join('')}
                    </div>

                    <div class="navigation-buttons">
                        ${pedido.estado !== 'oferta_recibida' ? `
                            <button class="btn btn-secondary btn-sm" onclick="retrocederEstado(${pedido.id})">
                                ← Anterior
                            </button>
                        ` : ''}
                        
                        ${pedido.estado === 'oferta_recibida' ? `
                            <button class="btn btn-sm" onclick="lanzarEproc(${pedido.id})">Lanzar Eproc</button>
                        ` : pedido.estado === 'eproc_lanzado' ? `
                            <button class="btn btn-sm" onclick="firmarEproc(${pedido.id})">Firmar Eproc</button>
                        ` : pedido.estado === 'eproc_firmado' ? `
                            <button class="btn btn-sm" onclick="crearPackingList(${pedido.id})">Crear Packing List</button>
                        ` : pedido.estado === 'packing_list_creado' ? `
                            <button class="btn btn-sm" onclick="lanzarTar(${pedido.id})">Lanzar TAR</button>
                        ` : pedido.estado === 'tar_lanzado' ? `
                            <button class="btn btn-sm" onclick="enviarEtiquetas(${pedido.id})">Enviar Etiquetas</button>
                        ` : pedido.estado === 'etiquetas_enviadas' ? `
                            <button class="btn btn-sm" onclick="avanzarEstado(${pedido.id})">Paquete recogido al proveedor</button>
                        ` : pedido.estado === 'recibido_planta' ? `
                            <button class="btn btn-sm" onclick="avanzarEstado(${pedido.id})">Paquete ha llegado al almacén</button>
                        ` : pedido.estado === 'sin_incidencias' ? `
                            <button class="btn btn-sm" onclick="avanzarEstado(${pedido.id})">Paquete recogido</button>
                        ` : `
                            <span class="btn btn-success btn-sm" style="cursor: default;">✓ Completado</span>
                        `}
                    </div>

                    <div id="detalles-${pedido.id}" class="detalles-panel">
                        <h4 style="margin-bottom: 15px;">Información del proceso</h4>
                        
                        <div class="info-section">
                            <h5>Oferta Recibida</h5>
                            <div class="info-grid">
                                <div>
                                    <p><strong>Número:</strong> ${pedido.numero_oferta}</p>
                                    <p><strong>Proveedor:</strong> ${pedido.proveedor}</p>
                                    <p><strong>Email:</strong> ${pedido.email_proveedor || 'N/A'}</p>
                                    <p><strong>Total:</strong> €${pedido.total.toFixed(3)}</p>
                                </div>
                                <div>
                                    <p><strong>Fecha:</strong> ${pedido.fecha_oferta || 'N/A'}</p>
                                </div>
                            </div>
                        </div>

                        ${(pedido.eproc || esTar) ? `
                            <div class="info-section">
                                <h5>Eproc ${esTar ? '(Pre-lanzado)' : 'Lanzado'}</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Número:</strong> ${pedido.eproc?.numero || 'N/A'}</p>
                                        ${pedido.eproc?.oi ? `<p><strong>OI:</strong> ${pedido.eproc.oi}</p>` : ''}
                                        ${pedido.eproc?.short_description ? `<p><strong>Short Description:</strong> ${pedido.eproc.short_description}</p>` : ''}
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.eproc?.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${pedido.eproc_firmado ? `
                            <div class="info-section">
                                <h5>Eproc Firmado</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>PO:</strong> ${pedido.eproc_firmado.po}</p>
                                        <p><strong>Fecha:</strong> ${pedido.eproc_firmado.fecha}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${pedido.packing_list ? `
                            <div class="info-section">
                                <h5>Packing List</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Dirección:</strong> ${pedido.packing_list.direccion}</p>
                                        <p><strong>Bultos:</strong> ${pedido.packing_list.bultos}</p>
                                        <p><strong>Peso Total:</strong> ${pedido.packing_list.peso_total || 0} kg</p>
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.packing_list.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                                ${pedido.configuracion_bultos ? `
                                    <div style="margin-top: 15px;">
                                        <h6 style="color: #374151; font-weight: 600; margin-bottom: 10px;">Configuración de Bultos:</h6>
                                        ${Object.entries(pedido.configuracion_bultos).map(([bulto, piezas]) => {
                                            const infoBulto = pedido.info_bultos && pedido.info_bultos[bulto];
                                            return `
                                                <div style="margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                                    <strong>${bulto.replace('_', ' ').charAt(0).toUpperCase() + bulto.replace('_', ' ').slice(1)}:</strong>
                                                    ${infoBulto ? `<span style="color: #6b7280; font-size: 12px;"> (${infoBulto.peso}kg${infoBulto.dimensiones ? `, ${infoBulto.dimensiones}` : ''})</span>` : ''}
                                                    <br>
                                                    ${piezas.length > 0 ? piezas.map(p => `${p.referencia} (${p.cantidad})`).join(', ') : 'Sin asignar'}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        ${pedido.tar ? `
                            <div class="info-section">
                                <h5>TAR Lanzado</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Número:</strong> ${pedido.tar.numero}</p>
                                        <p><strong>Email Logística:</strong> ${pedido.tar.email}</p>
                                        <p><strong>URL:</strong> ${pedido.tar.url}</p>
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.tar.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        ${pedido.etiquetas ? `
                            <div class="info-section">
                                <h5>Etiquetas Enviadas</h5>
                                <div class="info-grid">
                                    <div>
                                        <p><strong>Tracking:</strong> ${pedido.etiquetas.tracking}</p>
                                        <button class="btn btn-sm" onclick="consultarSeguimientoDHL('${pedido.etiquetas.tracking}')" 
                                                style="background: #ff6b00; color: white; border-color: #ff6b00; margin-top: 8px; font-size: 12px; padding: 6px 12px;">
                                            🚚 Seguir en DHL
                                        </button>
                                    </div>
                                    <div>
                                        <p><strong>Fecha:</strong> ${pedido.etiquetas.fecha || 'N/A'}</p>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <div class="info-section">
                            <h5>Documentos</h5>
                            <div class="pdf-tags">
                                <span class="pdf-tag clickable" onclick="abrirPDF('Oferta_${pedido.numero_oferta}.pdf', '${getFileData(pedido, 'oferta')}', ${pedido.id}, 'oferta')" 
                                      title="Click para abrir PDF">📄 Oferta_${pedido.numero_oferta}.pdf</span>
                                ${pedido.eproc_firmado ? `<span class="pdf-tag clickable" onclick="abrirPDF('PO_${pedido.eproc_firmado.po}.pdf', '${getFileData(pedido, 'po')}', ${pedido.id}, 'po')" 
                                      title="Click para abrir PDF">📄 PO_${pedido.eproc_firmado.po}.pdf</span>` : ''}
                                ${pedido.packing_list ? `<span class="pdf-tag clickable" onclick="abrirPDF('PackingList_${pedido.id}.pdf', '${getFileData(pedido, 'packing')}', ${pedido.id}, 'packing')" 
                                      title="Click para abrir PDF">📄 PackingList_${pedido.id}.pdf</span>` : ''}
                                ${pedido.etiquetas ? `<span class="pdf-tag clickable" onclick="abrirPDF('Etiquetas_${pedido.etiquetas.tracking}.pdf', '${getFileData(pedido, 'etiquetas')}', ${pedido.id}, 'etiquetas')" 
                                      title="Click para abrir PDF">📄 Etiquetas_${pedido.etiquetas.tracking}.pdf</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Modal functions
        function abrirModalCrearPedido() {
            document.getElementById('modal-crear-pedido').style.display = 'block';
            
            // Limpiar completamente el formulario
            document.getElementById('form-crear-pedido').reset();
            
            // Limpiar campos específicos manualmente
            document.getElementById('numero_oferta').value = '';
            document.getElementById('proveedor').value = '';
            document.getElementById('email_proveedor').value = '';
            document.getElementById('fecha_oferta').value = obtenerFechaHoy();
            document.getElementById('oferta_pdf').value = '';
            
            // Limpiar y reinicializar las piezas
            limpiarPiezas();
            agregarPieza();
            
            // Reinicializar el total
            document.getElementById('total-pedido').textContent = '0.000';
        }

        function abrirShortDescriptionGenerator() {
            document.getElementById('modal-short-description').style.display = 'block';
            limpiarCamposSD();
            setTimeout(() => {
                document.getElementById('sd-oferta').focus();
            }, 100);
        }

        function abrirModalCrearTar() {
            document.getElementById('modal-crear-tar').style.display = 'block';
            
            // Limpiar completamente el formulario
            document.getElementById('form-crear-tar').reset();
            
            // Limpiar campos específicos manualmente
            document.getElementById('tar_proveedor').value = '';
            document.getElementById('tar_email_proveedor').value = '';
            document.getElementById('tar_numero_oferta').value = '';
            document.getElementById('tar_fecha_oferta').value = obtenerFechaHoy();
            document.getElementById('tar_oferta_pdf').value = '';
            
            // Valores por defecto para EPROC
            const año = new Date().getFullYear();
            const numeroEproc = `EP${año}-TAR-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`;
            document.getElementById('tar_numero_eproc').value = numeroEproc;
            document.getElementById('tar_oi_eproc').value = '';
            
            // Limpiar y reinicializar las piezas TAR
            limpiarPiezasTar();
            agregarPiezaTar();
            
            // Reinicializar el total TAR
            document.getElementById('total-tar').textContent = '0.000';
        }

        function cerrarModal() {
            document.getElementById('modal-crear-pedido').style.display = 'none';
        }

        // Funciones para los nuevos modales
        function cerrarModalLanzarEproc() {
            document.getElementById('modal-lanzar-eproc').style.display = 'none';
        }

        function cerrarModalFirmarEproc() {
            document.getElementById('modal-firmar-eproc').style.display = 'none';
        }

        function cerrarModalPackingList() {
            document.getElementById('modal-packing-list').style.display = 'none';
        }

        function cerrarModalLanzarTar() {
            document.getElementById('modal-lanzar-tar').style.display = 'none';
        }

        function cerrarModalEnviarEtiquetas() {
            document.getElementById('modal-enviar-etiquetas').style.display = 'none';
        }

        function cerrarModalDetalle() {
            document.getElementById('modal-detalle-completo').style.display = 'none';
        }

        // Funciones para notas
        let pedidoIdNota = null;

        function abrirModalNota(pedidoId) {
            pedidoIdNota = pedidoId;
            
            // Buscar el pedido para mostrar las notas existentes
            const pedido = pedidos.find(p => p.id === pedidoId);
            const modalContent = document.querySelector('#modal-nota .modal-content');
            
            // Actualizar el título del modal
            const titulo = modalContent.querySelector('h2');
            titulo.textContent = `Notas - Pedido #${pedidoId}`;
            
            // Mostrar notas existentes antes del formulario
            const formNota = document.getElementById('form-nota');
            
            // Remover notas existentes si las hay
            const notasExistentes = modalContent.querySelector('.notas-existentes');
            if (notasExistentes) {
                notasExistentes.remove();
            }
            
            // Crear sección de notas existentes
            if (pedido && pedido.notas && pedido.notas.length > 0) {
                const notasDiv = document.createElement('div');
                notasDiv.className = 'notas-existentes';
                notasDiv.innerHTML = `
                    <h4 style="margin-bottom: 15px; color: #374151; font-size: 14px;">Notas existentes:</h4>
                    <div style="max-height: 200px; overflow-y: auto; margin-bottom: 20px;">
                        ${pedido.notas.map((nota, index) => `
                            <div class="nota-item" style="margin-bottom: 10px; position: relative;">
                                <button class="nota-eliminar" onclick="eliminarNota(${pedidoId}, ${index})" 
                                        title="Eliminar nota"
                                        style="position: absolute; top: 8px; right: 8px; background: #fee2e2; border: 1px solid #fecaca; color: #dc2626; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0;">
                                    ×
                                </button>
                                <div class="nota-fecha">${nota.fecha}</div>
                                <div class="nota-texto" style="padding-right: 30px;">${nota.texto}</div>
                            </div>
                        `).join('')}
                    </div>
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">
                `;
                formNota.parentNode.insertBefore(notasDiv, formNota);
            }
            
            document.getElementById('modal-nota').style.display = 'block';
            document.getElementById('texto-nota').value = '';
            document.getElementById('texto-nota').focus();
        }

        function cerrarModalNota() {
            document.getElementById('modal-nota').style.display = 'none';
            pedidoIdNota = null;
        }

        function guardarNota() {
            const texto = document.getElementById('texto-nota').value.trim();
            
            if (!texto) {
                alert('Por favor, escribe una nota antes de guardar.');
                return;
            }

            if (!pedidoIdNota) {
                alert('Error: No se ha seleccionado un pedido.');
                return;
            }

            const pedidoIndex = pedidos.findIndex(p => p.id === pedidoIdNota);
            if (pedidoIndex === -1) {
                alert('Error: Pedido no encontrado.');
                return;
            }

            // Crear la nota con fecha actual
            const nuevaNota = {
                texto: texto,
                fecha: new Date().toLocaleString('es-ES', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                })
            };

            // Añadir la nota al pedido
            if (!pedidos[pedidoIndex].notas) {
                pedidos[pedidoIndex].notas = [];
            }
            pedidos[pedidoIndex].notas.push(nuevaNota);

            // Guardar cambios
            localStorage.setItem('pedidos', JSON.stringify(pedidos));

            // Cerrar modal y actualizar vista
            cerrarModalNota();
            mostrarPedidos();
        }

        function eliminarNota(pedidoId, notaIndex) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta nota?')) {
                return;
            }

            const pedidoIndex = pedidos.findIndex(p => p.id === pedidoId);
            if (pedidoIndex === -1) {
                alert('Error: Pedido no encontrado.');
                return;
            }

            // Eliminar la nota del array
            if (pedidos[pedidoIndex].notas && pedidos[pedidoIndex].notas[notaIndex]) {
                pedidos[pedidoIndex].notas.splice(notaIndex, 1);
                
                // Si no quedan notas, eliminar el array completo
                if (pedidos[pedidoIndex].notas.length === 0) {
                    delete pedidos[pedidoIndex].notas;
                }

                // Guardar cambios
                localStorage.setItem('pedidos', JSON.stringify(pedidos));

                // Actualizar vista del modal
                abrirModalNota(pedidoId);
                
                // Actualizar vista principal
                mostrarPedidos();
            }
        }

        // Event listener para Ctrl+Enter en el textarea de notas
        document.addEventListener('DOMContentLoaded', function() {
            const textareaNota = document.getElementById('texto-nota');
            if (textareaNota) {
                textareaNota.addEventListener('keydown', function(event) {
                    if (event.ctrlKey && event.key === 'Enter') {
                        event.preventDefault();
                        guardarNota();
                    }
                });
            }
        });

        // Funciones para Short Description Generator
        function cerrarModalShortDescription() {
            document.getElementById('modal-short-description').style.display = 'none';
        }

        function limpiarCamposSD() {
            document.getElementById('sd-oferta').value = '';
            document.getElementById('sd-pieza').value = '';
            document.getElementById('sd-descripcion').value = '';
            document.getElementById('sd-proyecto').value = '';
            document.getElementById('sd-precio').value = '';
            document.getElementById('sd-resultado').value = '';
            document.getElementById('sd-success-message').style.display = 'none';
        }

        function pegarSD(id) {
            navigator.clipboard.readText()
                .then(text => {
                    document.getElementById(id).value = text.trim();
                    // Removido: Auto-generar si todos los campos están llenos
                    // La generación ahora solo se hace manualmente con el botón
                })
                .catch(err => {
                    console.error('Error al pegar desde el portapapeles:', err);
                });
        }

        function generarDescripcionSD() {
            const oferta = document.getElementById('sd-oferta').value.trim().replace(/\s+/g, '_');
            const pieza = document.getElementById('sd-pieza').value.trim().replace(/\s+/g, '_');
            const descripcion = document.getElementById('sd-descripcion').value.trim().replace(/\s+/g, '_');
            const proyecto = document.getElementById('sd-proyecto').value.trim().replace(/\s+/g, '_');
            const precio = document.getElementById('sd-precio').value.trim().replace(/\s+/g, '_');
            
            if (!oferta || !pieza || !descripcion || !proyecto || !precio) {
                alert('⚠️ Por favor, complete todos los campos antes de generar la descripción.');
                return;
            }
            
            const resultado = `${oferta}_${pieza}_${descripcion}_${proyecto}_${precio}`;
            document.getElementById('sd-resultado').value = resultado;
            
            // Enfocar el textarea del resultado
            document.getElementById('sd-resultado').focus();
        }

        function copiarAlPortapapelesSD() {
            const resultado = document.getElementById('sd-resultado').value;
            if (!resultado) {
                alert('⚠️ No hay ninguna descripción generada para copiar.');
                return;
            }
            
            navigator.clipboard.writeText(resultado)
                .then(() => {
                    mostrarMensajeExitoSD();
                })
                .catch(err => {
                    console.error("Error al copiar:", err);
                    alert('❌ Error al copiar al portapapeles.');
                });
        }

        function mostrarMensajeExitoSD() {
            const mensaje = document.getElementById('sd-success-message');
            mensaje.style.display = 'block';
            setTimeout(() => {
                mensaje.style.display = 'none';
            }, 3000);
        }

        function transferirAEproc() {
            const resultado = document.getElementById('sd-resultado').value;
            if (!resultado) {
                alert('⚠️ No hay ninguna descripción generada para transferir.');
                return;
            }
            
            // Verificar si el modal de EPROC está abierto
            const modalEproc = document.getElementById('modal-lanzar-eproc');
            if (!modalEproc || modalEproc.style.display === 'none') {
                alert('⚠️ El modal de Lanzar EPROC no está abierto.\n\nPrimero abre el modal de EPROC y luego usa el generador.');
                return;
            }
            
            // Transferir el texto al campo de short description
            const campoShortDescription = document.getElementById('lanzar_eproc_short_description');
            if (campoShortDescription) {
                campoShortDescription.value = resultado;
                
                // Cerrar el modal del generador
                cerrarModalShortDescription();
                
                // Mostrar mensaje de éxito
                alert('✅ Descripción transferida exitosamente al campo EPROC.');
            } else {
                alert('❌ Error: No se pudo encontrar el campo de descripción en el modal EPROC.');
            }
        }

        // ===============================
        // FUNCIONES PARA CREAR TAR
        // ===============================

        function cerrarModalCrearTar() {
            document.getElementById('modal-crear-tar').style.display = 'none';
        }

        function agregarPiezaTar() {
            const grid = document.getElementById('tar-pieces-grid');
            const pieceCount = grid.children.length;
            
            const pieceRow = document.createElement('div');
            pieceRow.className = 'piece-row';
            pieceRow.innerHTML = `
                <input type="text" name="referencia_${pieceCount}" placeholder="REF-001">
                <input type="text" name="descripcion_${pieceCount}" placeholder="Descripción de la pieza">
                <input type="text" name="proyecto_${pieceCount}" placeholder="Proyecto A">
                <input type="number" name="cantidad_${pieceCount}" value="1" min="1" onchange="calcularTotalTar(); actualizarTotalFilaTar(this)">
                <input type="number" name="precio_${pieceCount}" step="0.001" min="0" placeholder="0.000" onchange="calcularTotalTar(); actualizarTotalFilaTar(this)">
                <div class="total-fila" style="text-align: center; font-weight: bold; color: #059669; padding: 12px 15px; background: #f0fdf4; border-radius: 4px;">0.000</div>
                <button type="button" class="btn btn-secondary" onclick="eliminarPiezaTar(this)" style="padding: 10px 15px; font-size: 14px; font-weight: bold; width: 100%;">×</button>
            `;
            
            grid.appendChild(pieceRow);
        }

        function eliminarPiezaTar(button) {
            button.parentElement.remove();
            calcularTotalTar();
        }

        function limpiarPiezasTar() {
            const grid = document.getElementById('tar-pieces-grid');
            while (grid.children.length > 1) {
                grid.removeChild(grid.lastChild);
            }
            // Reiniciar el total TAR a 0
            document.getElementById('total-tar').textContent = '0.000';
        }

        function calcularTotalTar() {
            const grid = document.getElementById('tar-pieces-grid');
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseFloat(row.children[3].value) || 0;
                const precio = parseFloat(row.children[4].value) || 0;
                const subtotal = cantidad * precio;
                total += subtotal;
                
                // Actualizar total de la fila
                if (row.children[5]) {
                    row.children[5].textContent = subtotal.toFixed(3);
                }
            }
            
            document.getElementById('total-tar').textContent = total.toFixed(3);
        }

        // Funciones para actualizar totales individuales por fila
        function actualizarTotalFila(input) {
            const row = input.parentElement;
            const cantidad = parseFloat(row.children[3].value) || 0;
            const precio = parseFloat(row.children[4].value) || 0;
            const total = cantidad * precio;
            row.children[5].textContent = total.toFixed(3);
        }

        function actualizarTotalFilaTar(input) {
            const row = input.parentElement;
            const cantidad = parseFloat(row.children[3].value) || 0;
            const precio = parseFloat(row.children[4].value) || 0;
            const total = cantidad * precio;
            row.children[5].textContent = total.toFixed(3);
        }

        // Función para mostrar detalle completo en modal
        function mostrarDetalleCompleto(pedidoId) {
            const pedido = pedidos.find(p => p.id === pedidoId);
            if (!pedido) return;

            const esTar = pedido.tipo === 'TAR';
            const titulo = esTar ? `Detalles del TAR #${pedido.id}` : `Detalles del Pedido #${pedido.id}`;
            document.getElementById('detalle-titulo').textContent = titulo;
            
            const contenido = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div class="info-section">
                        <h3 style="color: #374151; margin-bottom: 15px; font-size: 18px;">📋 Información General</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                            <p><strong>ID:</strong> ${pedido.id}</p>
                            <p><strong>Número de Oferta:</strong> ${pedido.numero_oferta}</p>
                            <p><strong>Proveedor:</strong> ${pedido.proveedor}</p>
                            <p><strong>Email Proveedor:</strong> ${pedido.email_proveedor || 'N/A'}</p>
                            <p><strong>Fecha Creación:</strong> ${pedido.fecha_creacion}</p>
                            <p><strong>Fecha Oferta:</strong> ${pedido.fecha_oferta || 'N/A'}</p>
                            <p><strong>Estado Actual:</strong> <span style="color: #10b981; font-weight: bold;">${getNombreEstadoTexto(pedido.estado)}</span></p>
                            <p><strong>Total:</strong> <span style="color: #059669; font-weight: bold;">€${pedido.total.toFixed(3)}</span></p>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3 style="color: #374151; margin-bottom: 15px; font-size: 18px;">📦 Piezas del Pedido</h3>
                        <div style="background: #f9fafb; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto;">
                            ${pedido.piezas.map(pieza => `
                                <div style="border-bottom: 1px solid #e5e7eb; padding: 8px 0;">
                                    <p style="margin: 2px 0;"><strong>${pieza.referencia}</strong> - ${pieza.descripcion}</p>
                                    <p style="margin: 2px 0; font-size: 12px; color: #6b7280;">Proyecto: ${pieza.proyecto} | Cantidad: ${pieza.cantidad} | Precio: €${pieza.precio_unitario.toFixed(3)}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                ${pedido.eproc ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">🚀 EPROC Lanzado</h3>
                        <div style="background: #dbeafe; padding: 12px; border-radius: 6px;">
                            <p><strong>Número:</strong> ${pedido.eproc.numero}</p>
                            <p><strong>OI:</strong> ${pedido.eproc.oi || 'N/A'}</p>
                            ${pedido.eproc.short_description ? `<p><strong>Short Description:</strong> ${pedido.eproc.short_description}</p>` : ''}
                            <p><strong>Fecha:</strong> ${pedido.eproc.fecha || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                ${pedido.eproc_firmado ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">✍️ EPROC Firmado</h3>
                        <div style="background: #dcfce7; padding: 12px; border-radius: 6px;">
                            <p><strong>Número PO:</strong> ${pedido.eproc_firmado.po}</p>
                            <p><strong>Fecha:</strong> ${pedido.eproc_firmado.fecha}</p>
                            <p><strong>PDF:</strong> ${pedido.eproc_firmado.pdf || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                ${pedido.packing_list ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">📦 Packing List</h3>
                        <div style="background: #fef3c7; padding: 12px; border-radius: 6px;">
                            <p><strong>Dirección:</strong> ${pedido.packing_list.direccion}</p>
                            <p><strong>Número de Bultos:</strong> ${pedido.packing_list.bultos}</p>
                            <p><strong>Peso Total:</strong> ${pedido.packing_list.peso_total || 0} kg</p>
                            <p><strong>Fecha:</strong> ${pedido.packing_list.fecha || 'N/A'}</p>
                            <p><strong>PDF:</strong> ${pedido.packing_list.pdf || 'N/A'}</p>
                            ${pedido.configuracion_bultos ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                    <p style="font-weight: 600; margin-bottom: 10px;">Configuración de Bultos:</p>
                                    ${Object.entries(pedido.configuracion_bultos).map(([bulto, piezas]) => {
                                        const infoBulto = pedido.info_bultos && pedido.info_bultos[bulto];
                                        return `
                                            <div style="margin-bottom: 10px; padding: 10px; background: #fffbeb; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                                <p style="font-weight: 600; color: #92400e;">
                                                    ${bulto.replace('_', ' ').charAt(0).toUpperCase() + bulto.replace('_', ' ').slice(1)}
                                                    ${infoBulto ? `<span style="font-weight: normal; color: #6b7280;"> - ${infoBulto.peso}kg${infoBulto.dimensiones ? `, ${infoBulto.dimensiones}` : ''}</span>` : ''}
                                                </p>
                                                <p style="margin-top: 5px; color: #451a03;">
                                                    ${piezas.length > 0 ? piezas.map(p => `${p.referencia} - ${p.descripcion} (Cant: ${p.cantidad})`).join('<br>') : 'Sin piezas asignadas'}
                                                </p>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                ` : ''}

                ${pedido.tar ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">🚚 TAR Lanzado</h3>
                        <div style="background: #fce7f3; padding: 12px; border-radius: 6px;">
                            <p><strong>Número TAR:</strong> ${pedido.tar.numero}</p>
                            <p><strong>Email Logística:</strong> ${pedido.tar.email}</p>
                            <p><strong>URL:</strong> ${pedido.tar.url || 'N/A'}</p>
                            <p><strong>Fecha:</strong> ${pedido.tar.fecha || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                ${pedido.etiquetas ? `
                    <div class="info-section" style="margin-bottom: 20px;">
                        <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">🏷️ Etiquetas Enviadas</h3>
                        <div style="background: #e0e7ff; padding: 12px; border-radius: 6px;">
                            <p><strong>Tracking:</strong> ${pedido.etiquetas.tracking}</p>
                            <button class="btn btn-sm" onclick="consultarSeguimientoDHL('${pedido.etiquetas.tracking}')" 
                                    style="background: #ff6b00; color: white; border-color: #ff6b00; margin: 10px 0; font-size: 12px; padding: 6px 12px;">
                                🚚 Seguir en DHL
                            </button>
                            <p><strong>Fecha:</strong> ${pedido.etiquetas.fecha || 'N/A'}</p>
                            <p><strong>PDF:</strong> ${pedido.etiquetas.pdf || 'N/A'}</p>
                        </div>
                    </div>
                ` : ''}

                <div class="info-section">
                    <h3 style="color: #374151; margin-bottom: 10px; font-size: 16px;">📄 Documentos</h3>
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 6px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <span class="pdf-tag clickable" onclick="abrirPDF('Oferta_${pedido.numero_oferta}.pdf', '${getFileData(pedido, 'oferta')}')" 
                                  title="Click para abrir PDF">📄 Oferta_${pedido.numero_oferta}.pdf</span>
                            ${pedido.eproc_firmado ? `<span class="pdf-tag clickable" onclick="abrirPDF('PO_${pedido.eproc_firmado.po}.pdf', '${getFileData(pedido, 'po')}')" 
                                  title="Click para abrir PDF">📄 PO_${pedido.eproc_firmado.po}.pdf</span>` : ''}
                            ${pedido.packing_list ? `<span class="pdf-tag clickable" onclick="abrirPDF('PackingList_${pedido.id}.pdf', '${getFileData(pedido, 'packing')}')" 
                                  title="Click para abrir PDF">📄 PackingList_${pedido.id}.pdf</span>` : ''}
                            ${pedido.etiquetas ? `<span class="pdf-tag clickable" onclick="abrirPDF('Etiquetas_${pedido.etiquetas.tracking}.pdf', '${getFileData(pedido, 'etiquetas')}')" 
                                  title="Click para abrir PDF">📄 Etiquetas_${pedido.etiquetas.tracking}.pdf</span>` : ''}
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('detalle-contenido').innerHTML = contenido;
            document.getElementById('modal-detalle-completo').style.display = 'block';
        }

        // Funciones de piezas
        function agregarPieza() {
            const grid = document.getElementById('pieces-grid');
            const pieceCount = grid.children.length;
            
            const pieceRow = document.createElement('div');
            pieceRow.className = 'piece-row';
            pieceRow.innerHTML = `
                <input type="text" name="referencia_${pieceCount}" placeholder="REF-001">
                <input type="text" name="descripcion_${pieceCount}" placeholder="Descripción de la pieza">
                <input type="text" name="proyecto_${pieceCount}" placeholder="Proyecto A">
                <input type="number" name="cantidad_${pieceCount}" value="1" min="1" onchange="calcularTotal(); actualizarTotalFila(this)">
                <input type="number" name="precio_${pieceCount}" step="0.001" min="0" placeholder="0.000" onchange="calcularTotal(); actualizarTotalFila(this)">
                <div class="total-fila" style="text-align: center; font-weight: bold; color: #059669; padding: 12px 15px; background: #f0fdf4; border-radius: 4px;">0.000</div>
                <button type="button" class="btn btn-secondary" onclick="eliminarPieza(this)" style="padding: 10px 15px; font-size: 14px; font-weight: bold; width: 100%;">×</button>
            `;
            
            grid.appendChild(pieceRow);
        }

        function eliminarPieza(button) {
            button.parentElement.remove();
            calcularTotal();
        }

        function limpiarPiezas() {
            const grid = document.getElementById('pieces-grid');
            while (grid.children.length > 1) {
                grid.removeChild(grid.lastChild);
            }
            // Reiniciar el total a 0
            document.getElementById('total-pedido').textContent = '0.000';
        }

        function calcularTotal() {
            const grid = document.getElementById('pieces-grid');
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseFloat(row.children[3].value) || 0;
                const precio = parseFloat(row.children[4].value) || 0;
                const subtotal = cantidad * precio;
                total += subtotal;
                
                // Actualizar total de la fila
                if (row.children[5]) {
                    row.children[5].textContent = subtotal.toFixed(3);
                }
            }
            
            document.getElementById('total-pedido').textContent = total.toFixed(3);
        }

        // Toggle detalles
        function toggleDetalles(pedidoId) {
            const detalles = document.getElementById(`detalles-${pedidoId}`);
            const icon = document.getElementById(`toggle-icon-${pedidoId}`);
            
            if (detalles.classList.contains('show')) {
                detalles.classList.remove('show');
                icon.textContent = '▼';
            } else {
                detalles.classList.add('show');
                icon.textContent = '▲';
            }
        }

        // Funciones específicas para cada estado
        function lanzarEproc(pedidoId) {
            document.getElementById('modal-lanzar-eproc').style.display = 'block';
            document.getElementById('lanzar-eproc-pedido-id').value = pedidoId;
            
            // Valores por defecto
            const año = new Date().getFullYear();
            document.getElementById('lanzar_eproc_numero').value = `EP${año}-${pedidoId.toString().padStart(3, '0')}`;
            document.getElementById('lanzar_eproc_fecha').value = obtenerFechaHoy();
        }

        function firmarEproc(pedidoId) {
            document.getElementById('modal-firmar-eproc').style.display = 'block';
            document.getElementById('firmar-eproc-pedido-id').value = pedidoId;
            document.getElementById('firmar_eproc_fecha').value = obtenerFechaHoy();
        }

        function crearPackingList(pedidoId) {
            document.getElementById('modal-packing-list').style.display = 'block';
            document.getElementById('packing-list-pedido-id').value = pedidoId;
            document.getElementById('packing_list_fecha').value = obtenerFechaHoy();
            
            // Resetear configuración de bultos
            document.getElementById('configuracion-bultos-container').style.display = 'none';
            document.getElementById('packing_list_bultos').value = '';
        }

        function generarConfiguracionBultos() {
            const numBultos = parseInt(document.getElementById('packing_list_bultos').value);
            const pedidoId = parseInt(document.getElementById('packing-list-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (!numBultos || !pedido) {
                document.getElementById('configuracion-bultos-container').style.display = 'none';
                return;
            }

            document.getElementById('configuracion-bultos-container').style.display = 'block';
            
            // Inicializar datos globales para la configuración
            window.piezasDisponibles = [...pedido.piezas];
            window.configuracionBultos = {};
            window.infoBultos = {};
            
            // Inicializar bultos vacíos con información adicional
            for (let i = 1; i <= numBultos; i++) {
                window.configuracionBultos[`bulto_${i}`] = [];
                window.infoBultos[`bulto_${i}`] = {
                    peso: 0,
                    dimensiones: ''
                };
            }
            
            // Llenar selector de bultos
            const selector = document.getElementById('bulto-selector');
            selector.innerHTML = '';
            for (let i = 1; i <= numBultos; i++) {
                const option = document.createElement('option');
                option.value = `bulto_${i}`;
                option.textContent = `Bulto ${i}`;
                selector.appendChild(option);
            }
            
            // Cargar primera vista
            mostrarPiezasDisponibles();
            mostrarContenidoBulto();
            cargarInfoBulto();
            
            // Event listener para cambio de bulto
            selector.onchange = () => {
                mostrarContenidoBulto();
                cargarInfoBulto();
            };
        }

        function mostrarPiezasDisponibles() {
            const container = document.getElementById('piezas-disponibles');
            container.innerHTML = '';
            
            window.piezasDisponibles.forEach((pieza, index) => {
                const div = document.createElement('div');
                div.className = 'pieza-item';
                div.style.cssText = `
                    padding: 10px;
                    margin: 5px 0;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                div.onclick = () => seleccionarPieza(div, index);
                div.innerHTML = `
                    <div style="font-weight: 600; color: #374151;">${pieza.referencia}</div>
                    <div style="font-size: 12px; color: #6b7280;">${pieza.descripcion}</div>
                    <div style="font-size: 12px; color: #059669;">Cantidad: ${pieza.cantidad}</div>
                `;
                container.appendChild(div);
            });
        }

        function mostrarContenidoBulto() {
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            const container = document.getElementById('bulto-contenido');
            
            if (!bultoSeleccionado) return;
            
            const piezasEnBulto = window.configuracionBultos[bultoSeleccionado] || [];
            container.innerHTML = '';
            
            if (piezasEnBulto.length === 0) {
                container.innerHTML = `
                    <p style="color: #9ca3af; text-align: center; margin-top: 50px;">
                        Este bulto está vacío.<br>
                        Seleccione piezas de la izquierda y use el botón → para agregar.
                    </p>
                `;
                return;
            }
            
            piezasEnBulto.forEach((pieza, index) => {
                const div = document.createElement('div');
                div.className = 'pieza-en-bulto';
                div.style.cssText = `
                    padding: 10px;
                    margin: 5px 0;
                    border: 1px solid #10b981;
                    border-radius: 6px;
                    background: #ecfdf5;
                    cursor: pointer;
                    transition: all 0.2s;
                `;
                div.onclick = () => seleccionarPiezaEnBulto(div, index);
                div.innerHTML = `
                    <div style="font-weight: 600; color: #065f46;">${pieza.referencia}</div>
                    <div style="font-size: 12px; color: #047857;">${pieza.descripcion}</div>
                    <div style="font-size: 12px; color: #059669;">Cantidad: ${pieza.cantidad}</div>
                `;
                container.appendChild(div);
            });
        }

        function cargarInfoBulto() {
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            const infoContainer = document.getElementById('info-bulto-container');
            
            if (!bultoSeleccionado) {
                infoContainer.style.display = 'none';
                return;
            }
            
            infoContainer.style.display = 'block';
            
            const infoBulto = window.infoBultos[bultoSeleccionado];
            document.getElementById('bulto-peso').value = infoBulto.peso;
            document.getElementById('bulto-dimensiones').value = infoBulto.dimensiones;
        }

        function actualizarInfoBulto() {
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            
            if (!bultoSeleccionado) return;
            
            const peso = parseFloat(document.getElementById('bulto-peso').value) || 0;
            const dimensiones = document.getElementById('bulto-dimensiones').value || '';
            
            window.infoBultos[bultoSeleccionado] = {
                peso: peso,
                dimensiones: dimensiones
            };
            
            // Actualizar peso total automáticamente
            actualizarPesoTotal();
        }

        function actualizarPesoTotal() {
            let pesoTotal = 0;
            Object.values(window.infoBultos || {}).forEach(info => {
                pesoTotal += info.peso || 0;
            });
            
            document.getElementById('packing_list_peso_total').value = pesoTotal.toFixed(1);
        }

        function seleccionarPieza(elemento, index) {
            // Limpiar selecciones anteriores
            document.querySelectorAll('.pieza-item').forEach(item => {
                item.style.background = 'white';
                item.style.borderColor = '#d1d5db';
            });
            document.querySelectorAll('.pieza-en-bulto').forEach(item => {
                item.style.background = '#ecfdf5';
                item.style.borderColor = '#10b981';
            });
            
            // Seleccionar elemento actual
            elemento.style.background = '#dbeafe';
            elemento.style.borderColor = '#3b82f6';
            window.piezaSeleccionadaIndex = index;
            window.piezaSeleccionadaEnBulto = null;
        }

        function seleccionarPiezaEnBulto(elemento, index) {
            // Limpiar selecciones anteriores
            document.querySelectorAll('.pieza-item').forEach(item => {
                item.style.background = 'white';
                item.style.borderColor = '#d1d5db';
            });
            document.querySelectorAll('.pieza-en-bulto').forEach(item => {
                item.style.background = '#ecfdf5';
                item.style.borderColor = '#10b981';
            });
            
            // Seleccionar elemento actual
            elemento.style.background = '#fef3c7';
            elemento.style.borderColor = '#f59e0b';
            window.piezaSeleccionadaEnBulto = index;
            window.piezaSeleccionadaIndex = null;
        }

        function moverPiezaABulto() {
            if (window.piezaSeleccionadaIndex === null || window.piezaSeleccionadaIndex === undefined) {
                alert('Seleccione una pieza de la lista de disponibles');
                return;
            }
            
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            
            if (!bultoSeleccionado) {
                alert('Seleccione un bulto');
                return;
            }
            
            // Mover pieza
            const pieza = window.piezasDisponibles[window.piezaSeleccionadaIndex];
            window.configuracionBultos[bultoSeleccionado].push(pieza);
            window.piezasDisponibles.splice(window.piezaSeleccionadaIndex, 1);
            
            // Actualizar vistas
            mostrarPiezasDisponibles();
            mostrarContenidoBulto();
            
            // Limpiar selección
            window.piezaSeleccionadaIndex = null;
        }

        function regresarPiezaADisponibles() {
            if (window.piezaSeleccionadaEnBulto === null || window.piezaSeleccionadaEnBulto === undefined) {
                alert('Seleccione una pieza del bulto');
                return;
            }
            
            const selector = document.getElementById('bulto-selector');
            const bultoSeleccionado = selector.value;
            
            if (!bultoSeleccionado) return;
            
            // Mover pieza de vuelta
            const pieza = window.configuracionBultos[bultoSeleccionado][window.piezaSeleccionadaEnBulto];
            window.piezasDisponibles.push(pieza);
            window.configuracionBultos[bultoSeleccionado].splice(window.piezaSeleccionadaEnBulto, 1);
            
            // Actualizar vistas
            mostrarPiezasDisponibles();
            mostrarContenidoBulto();
            
            // Limpiar selección
            window.piezaSeleccionadaEnBulto = null;
        }

        function lanzarTar(pedidoId) {
            document.getElementById('modal-lanzar-tar').style.display = 'block';
            document.getElementById('lanzar-tar-pedido-id').value = pedidoId;
            document.getElementById('lanzar_tar_numero').value = `TAR-${pedidoId}`;
            document.getElementById('lanzar_tar_email').value = 'logistica@empresa.com';
            document.getElementById('lanzar_tar_fecha').value = obtenerFechaHoy();
        }

        function enviarEtiquetas(pedidoId) {
            document.getElementById('modal-enviar-etiquetas').style.display = 'block';
            document.getElementById('enviar-etiquetas-pedido-id').value = pedidoId;
            document.getElementById('enviar_etiquetas_fecha').value = obtenerFechaHoy();
            // Limpiar el campo de dirección de recogida (sin valor por defecto)
            document.getElementById('enviar_etiquetas_direccion_envio').value = '';
        }

        function eliminarPedido(pedidoId) {
            if (confirm('¿Está seguro de que desea eliminar este pedido? Esta acción no se puede deshacer.')) {
                pedidos = pedidos.filter(p => p.id !== pedidoId);
                guardarDatos();
                mostrarPedidos();
            }
        }

        // ===============================
        // FUNCIONES PARA SEGUIMIENTO DHL
        // ===============================

        function abrirModalSeguimiento() {
            document.getElementById('modal-seguimiento-dhl').style.display = 'block';
            document.getElementById('tracking-input').value = '';
            document.getElementById('dhl-frame-container').style.display = 'none';
            document.getElementById('instrucciones-iniciales').style.display = 'block';
            
            // Enfocar el input de tracking
            setTimeout(() => {
                document.getElementById('tracking-input').focus();
            }, 100);
        }

        function cerrarModalSeguimiento() {
            document.getElementById('modal-seguimiento-dhl').style.display = 'none';
            // Limpiar el contenido de seguimiento
            document.getElementById('dhl-frame-container').style.display = 'none';
            document.getElementById('instrucciones-iniciales').style.display = 'block';
        }

        function consultarSeguimientoDHL(trackingNumber) {
            // Si se llama desde un pedido específico, abrir modal y usar ese tracking
            if (trackingNumber) {
                abrirModalSeguimiento();
                document.getElementById('tracking-input').value = trackingNumber;
                setTimeout(() => {
                    consultarAPIDHL();
                }, 500);
            } else {
                abrirModalSeguimiento();
            }
        }

        async function abrirSeguimientoDHL() {
            await consultarAPIDHL();
        }

        async function consultarAPIDHL() {
            const trackingNumber = document.getElementById('tracking-input').value.trim();
            
            if (!trackingNumber) {
                alert('❌ Por favor, ingresa un número de tracking válido');
                return;
            }

            // Validar formato básico del tracking
            if (trackingNumber.length < 4) {
                alert('❌ El número de tracking parece ser muy corto. Verifica que sea correcto.');
                return;
            }

            // Mostrar estado de carga
            mostrarEstadoCarga();

            try {
                // Llamar a la API de DHL
                const datos = await obtenerDatosDHL(trackingNumber);
                mostrarResultadosSeguimiento(datos);
            } catch (error) {
                console.error('Error al consultar DHL:', error);
                mostrarErrorSeguimiento(error.message);
            }
        }

        async function obtenerDatosDHL(trackingNumber) {
            // Configuración de la API de DHL Unified Tracking
            const API_KEY = 'wBZWFUC9AUaFCd8WVDsWp19wmAXhpVQo'; // ✅ NEW UNIFIED API KEY
            const API_URL = 'https://api-eu.dhl.com/track/shipments'; // DHL Unified Tracking API
            
            // Código para API real de DHL Unified Tracking
            console.log('🟢 Consultando API DHL Unified Tracking...');
            console.log('🔍 Tracking Number:', trackingNumber);
            console.log('🔑 API Key (primeros 8 chars):', API_KEY.substring(0, 8) + '...');
            
            // URL correcta para DHL Unified Tracking
            const queryParams = new URLSearchParams({
                trackingNumber: trackingNumber
            });
            const fullURL = `${API_URL}?${queryParams}`;
            console.log('🌐 URL completa:', fullURL);
            
            const response = await fetch(fullURL, {
                method: 'GET',
                headers: {
                    'DHL-API-Key': API_KEY,
                    'Accept': 'application/json',
                    'Accept-Language': 'es-ES'
                }
            });

            console.log('📡 Response status:', response.status);
            console.log('📡 Response statusText:', response.statusText);

            // Obtener headers de respuesta para debugging
            const responseHeaders = {};
            for (let [key, value] of response.headers.entries()) {
                responseHeaders[key] = value;
            }
            console.log('📡 Response headers:', responseHeaders);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('❌ Error response body:', errorText);
                
                if (response.status === 401) {
                    throw new Error('❌ API Key inválida o no autorizada. Tu API está "pending" - espera a que se active.');
                } else if (response.status === 404) {
                    throw new Error('❌ Número de tracking no encontrado en DHL.');
                } else if (response.status === 429) {
                    throw new Error('❌ Límite de consultas excedido (250/día). Espera hasta mañana.');
                } else if (response.status === 403) {
                    throw new Error('❌ Acceso denegado. Tu API Key está en estado "pending" - contacta a DHL.');
                } else if (response.status === 400) {
                    throw new Error('❌ Formato de tracking number inválido.');
                }
                throw new Error(`❌ Error HTTP ${response.status}: ${response.statusText}. Body: ${errorText}`);
            }

            const data = await response.json();
            console.log('📦 Datos RAW recibidos de DHL:', data);
            
            // Verificar estructura de datos
            if (!data.shipments || data.shipments.length === 0) {
                console.warn('⚠️ No se encontraron shipments en la respuesta');
                throw new Error('No se encontró información para este número de tracking');
            }

            // Procesar con la función estándar de DHL
            return procesarDatosAPIDHL(data.shipments[0]);
        }

        function procesarDatosAPIDHL(shipment) {
            // Procesar datos reales de la API de DHL
            console.log('📦 Procesando datos reales de DHL API');
            
            return {
                trackingNumber: shipment.id,
                status: {
                    statusCode: shipment.status.statusCode,
                    status: shipment.status.status,
                    description: shipment.status.description || 'Sin descripción disponible'
                },
                service: shipment.service || 'DHL Express',
                origin: shipment.origin || {
                    address: {
                        addressLocality: 'Origen no disponible',
                        countryCode: 'XX',
                        country: 'No disponible'
                    }
                },
                destination: shipment.destination || {
                    address: {
                        addressLocality: 'Destino no disponible',
                        countryCode: 'XX',
                        country: 'No disponible'
                    }
                },
                estimatedDeliveryDate: shipment.estimatedTimeOfDelivery || null,
                events: shipment.events ? shipment.events.map(event => ({
                    timestamp: event.timestamp,
                    location: event.location || {
                        address: {
                            addressLocality: 'Ubicación no disponible',
                            countryCode: 'XX'
                        }
                    },
                    statusCode: event.statusCode,
                    status: event.status,
                    description: event.description || 'Sin descripción'
                })) : []
            };
        }

        function procesarDatosGlobalForwarding(data, trackingNumber) {
            // Procesar datos reales de DHL Global Forwarding API
            console.log('📦 Procesando datos de DHL Global Forwarding API');
            
            // DHL Global Forwarding tiene una estructura diferente
            const shipment = data.shipment || data;
            
            return {
                trackingNumber: trackingNumber,
                status: {
                    statusCode: shipment.status?.statusCode || 'unknown',
                    status: shipment.status?.status || shipment.shipmentStatus || 'En Proceso',
                    description: shipment.status?.description || shipment.statusDescription || 'Información de seguimiento disponible'
                },
                service: shipment.service || shipment.productName || 'DHL Global Forwarding',
                origin: {
                    address: {
                        addressLocality: shipment.origin?.address?.addressLocality || shipment.originLocation || 'Origen no disponible',
                        countryCode: shipment.origin?.address?.countryCode || 'XX',
                        country: shipment.origin?.address?.country || 'No disponible'
                    }
                },
                destination: {
                    address: {
                        addressLocality: shipment.destination?.address?.addressLocality || shipment.destinationLocation || 'Destino no disponible',
                        countryCode: shipment.destination?.address?.countryCode || 'XX',
                        country: shipment.destination?.address?.country || 'No disponible'
                    }
                },
                estimatedDeliveryDate: shipment.estimatedDeliveryDate || shipment.estimatedTimeOfDelivery || null,
                events: (shipment.events || shipment.trackingEvents || []).map(event => ({
                    timestamp: event.timestamp || event.eventTime || new Date().toISOString(),
                    location: {
                        address: {
                            addressLocality: event.location?.address?.addressLocality || event.location || 'Ubicación no disponible',
                            countryCode: event.location?.address?.countryCode || 'XX'
                        }
                    },
                    statusCode: event.statusCode || event.eventCode || 'info',
                    status: event.status || event.eventDescription || 'Evento',
                    description: event.description || event.eventDetails || 'Información del evento'
                }))
            };
        }

        function mostrarEstadoCarga() {
            document.getElementById('instrucciones-iniciales').style.display = 'none';
            document.getElementById('dhl-frame-container').style.display = 'block';
            
            const container = document.getElementById('dhl-frame-container');
            container.innerHTML = `
                <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 40px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">⏳</div>
                    <h3 style="color: #374151; margin-bottom: 10px;">Consultando seguimiento...</h3>
                    <p style="color: #6b7280;">Obteniendo información actualizada desde DHL</p>
                    <div style="margin-top: 20px;">
                        <div style="width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; overflow: hidden;">
                            <div style="width: 100%; height: 100%; background: #ff6b00; animation: loading 2s infinite;"></div>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes loading {
                        0% { transform: translateX(-100%); }
                        100% { transform: translateX(100%); }
                    }
                </style>
            `;
        }

        function mostrarResultadosSeguimiento(datos) {
            const trackingNumber = datos.trackingNumber;
            const status = datos.status;
            const service = datos.service;
            const origin = datos.origin;
            const destination = datos.destination;
            const estimatedDate = datos.estimatedDeliveryDate;
            const events = datos.events || [];

            const container = document.getElementById('dhl-frame-container');
            container.innerHTML = `
                <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                    <div style="background: #ff6b00; color: white; padding: 20px; text-align: center;">
                        <h3 style="margin: 0; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span>📦</span>
                            Seguimiento DHL - ${trackingNumber}
                            <span>🚚</span>
                        </h3>
                    </div>
                    
                    <!-- Información del envío -->
                    <div style="padding: 20px; background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <div>
                                <h4 style="color: #374151; margin-bottom: 10px;">📋 Estado Actual</h4>
                                <p style="font-size: 18px; font-weight: bold; color: ${obtenerColorEstado(status.statusCode)}; margin: 5px 0;">
                                    ${status.status}
                                </p>
                                <p style="color: #6b7280; font-size: 14px;">${status.description}</p>
                            </div>
                            
                            <div>
                                <h4 style="color: #374151; margin-bottom: 10px;">🚚 Servicio</h4>
                                <p style="color: #374151; margin: 5px 0;">${service}</p>
                                ${estimatedDate ? `<p style="color: #6b7280; font-size: 14px;">Entrega estimada: ${formatearFecha(estimatedDate)}</p>` : ''}
                            </div>
                            
                            <div>
                                <h4 style="color: #374151; margin-bottom: 10px;">📍 Ruta</h4>
                                <p style="color: #374151; margin: 5px 0;">
                                    <strong>Origen:</strong> ${origin.address.addressLocality}, ${origin.address.country}
                                </p>
                                <p style="color: #374151; margin: 5px 0;">
                                    <strong>Destino:</strong> ${destination.address.addressLocality}, ${destination.address.country}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timeline de eventos -->
                    <div style="padding: 20px;">
                        <h4 style="color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            📋 Historial de Seguimiento
                        </h4>
                        <div style="position: relative;">
                            ${events.map((evento, index) => `
                                <div style="display: flex; margin-bottom: 20px; position: relative;">
                                    <div style="
                                        width: 40px; 
                                        height: 40px; 
                                        border-radius: 50%; 
                                        background: ${obtenerColorEstado(evento.statusCode)}; 
                                        color: white; 
                                        display: flex; 
                                        align-items: center; 
                                        justify-content: center; 
                                        font-size: 18px; 
                                        margin-right: 15px;
                                        flex-shrink: 0;
                                        z-index: 2;
                                        position: relative;
                                    ">
                                        ${obtenerIconoEstado(evento.statusCode)}
                                    </div>
                                    ${index < events.length - 1 ? `
                                        <div style="
                                            position: absolute;
                                            left: 19px;
                                            top: 40px;
                                            width: 2px;
                                            height: 40px;
                                            background: #e5e7eb;
                                            z-index: 1;
                                        "></div>
                                    ` : ''}
                                    <div style="flex: 1;">
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                            <strong style="color: #374151; font-size: 16px;">${evento.status}</strong>
                                            <span style="color: #6b7280; font-size: 14px;">${formatearFechaHora(evento.timestamp)}</span>
                                        </div>
                                        <p style="color: #374151; margin: 5px 0; font-size: 14px;">${evento.description}</p>
                                        <p style="color: #6b7280; font-size: 12px; margin: 0;">
                                            📍 ${evento.location.address.addressLocality}${evento.location.address.countryCode ? `, ${evento.location.address.countryCode}` : ''}
                                        </p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Enlace a DHL oficial -->
                    <div style="background: #f9fafb; padding: 15px; text-align: center; border-top: 1px solid #e5e7eb;">
                        <p style="color: #6b7280; font-size: 14px; margin: 0;">
                            💡 Para más detalles, consulta directamente en 
                            <a href="https://www.dhl.com/es-es/home/tracking.html?tracking-id=${trackingNumber}" 
                               target="_blank" 
                               style="color: #ff6b00; text-decoration: none; font-weight: 500;">
                                DHL.com
                            </a>
                        </p>
                    </div>
                </div>
            `;
        }

        function mostrarErrorSeguimiento(mensaje) {
            const container = document.getElementById('dhl-frame-container');
            container.innerHTML = `
                <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 40px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                    <h3 style="color: #dc2626; margin-bottom: 15px;">Error al consultar seguimiento</h3>
                    <p style="color: #6b7280; margin-bottom: 20px;">${mensaje}</p>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button onclick="consultarAPIDHL()" class="btn btn-secondary">Intentar de nuevo</button>
                        <a href="https://www.dhl.com/es-es/home/tracking.html" target="_blank" 
                           style="display: inline-block; padding: 10px 20px; background: #ff6b00; color: white; text-decoration: none; border-radius: 6px;">
                            Consultar en DHL.com
                        </a>
                    </div>
                </div>
            `;
        }

        function obtenerColorEstado(statusCode) {
            const colores = {
                'pickup': '#3b82f6',      // Azul
                'transit': '#f59e0b',     // Amarillo/Naranja
                'delivered': '#10b981',   // Verde
                'failure': '#dc2626',     // Rojo
                'unknown': '#6b7280'      // Gris
            };
            return colores[statusCode] || '#6b7280';
        }

        function obtenerIconoEstado(statusCode) {
            const iconos = {
                'pickup': '📦',
                'transit': '🚚',
                'delivered': '✅',
                'failure': '⚠️',
                'unknown': '❓'
            };
            return iconos[statusCode] || '📋';
        }

        function formatearFecha(fechaISO) {
            if (!fechaISO) return 'N/A';
            const fecha = new Date(fechaISO);
            return fecha.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function formatearFechaHora(fechaHoraISO) {
            if (!fechaHoraISO) return 'N/A';
            const fecha = new Date(fechaHoraISO);
            return fecha.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Función para permitir Enter en el input de tracking
        document.addEventListener('DOMContentLoaded', function() {
            // Este listener se agregará cuando se cargue completamente la página
            setTimeout(() => {
                const trackingInput = document.getElementById('tracking-input');
                if (trackingInput) {
                    trackingInput.addEventListener('keypress', function(event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            consultarAPIDHL();
                        }
                    });
                }
            }, 1000);
        });

        // Funciones para manejo de PDFs
        function getFileData(pedido, tipo) {
            // Devuelve la URL del archivo almacenado o un placeholder
            switch(tipo) {
                case 'oferta':
                    return pedido.oferta_pdf || '';
                case 'eproc':
                    return ''; // EPROC lanzado no tiene PDF, solo el firmado
                case 'po':
                    return (pedido.eproc_firmado && pedido.eproc_firmado.pdf_url) || '';
                case 'packing':
                    return (pedido.packing_list && pedido.packing_list.pdf_url) || '';
                case 'etiquetas':
                    return (pedido.etiquetas && pedido.etiquetas.pdf_url) || '';
                default:
                    return '';
            }
        }

        function abrirPDF(nombreArchivo, fileData, pedidoId, tipo) {
            if (fileData && fileData.startsWith('data:')) {
                try {
                    // Si es un archivo base64, crear un blob y abrirlo
                    const byteCharacters = atob(fileData.split(',')[1]);
                    const byteNumbers = new Array(byteCharacters.length);
                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], {type: 'application/pdf'});
                    const url = URL.createObjectURL(blob);
                    window.open(url, '_blank');
                    
                    // Limpiar la URL después de un tiempo
                    setTimeout(() => URL.revokeObjectURL(url), 10000);
                } catch (error) {
                    console.error('Error al abrir PDF:', error);
                    mostrarOpcionCargarPDF(nombreArchivo, pedidoId, tipo);
                }
            } else if (fileData && fileData.startsWith('http')) {
                // Si es una URL, abrirla directamente
                window.open(fileData, '_blank');
            } else {
                // Si no hay archivo, mostrar opción de carga
                mostrarOpcionCargarPDF(nombreArchivo, pedidoId, tipo);
            }
        }

        function mostrarOpcionCargarPDF(nombreArchivo, pedidoId, tipo) {
            const resultado = confirm(`📄 ${nombreArchivo}\n\n❌ Archivo no disponible o corrupto.\n\n¿Deseas cargar este archivo ahora?`);
            
            if (resultado) {
                abrirSelectorArchivoPDF(pedidoId, tipo, nombreArchivo);
            }
        }

        function abrirSelectorArchivoPDF(pedidoId, tipo, nombreArchivo) {
            // Crear un input file temporal
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf';
            input.style.display = 'none';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    procesarYGuardarPDF(file, pedidoId, tipo, nombreArchivo);
                } else {
                    alert('❌ Por favor, selecciona un archivo PDF válido.');
                }
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        async function procesarYGuardarPDF(file, pedidoId, tipo, nombreArchivo) {
            try {
                // Mostrar mensaje de procesamiento
                const originalAlert = alert;
                
                // Procesar archivo a Base64
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64Data = e.target.result;
                    
                    // Buscar el pedido y actualizar el campo correspondiente
                    const pedido = pedidos.find(p => p.id === pedidoId);
                    if (!pedido) {
                        alert('❌ Error: No se encontró el pedido.');
                        return;
                    }
                    
                    // Guardar el PDF en el campo correspondiente
                    switch(tipo) {
                        case 'oferta':
                            pedido.oferta_pdf = base64Data;
                            break;
                        case 'po':
                            if (!pedido.eproc_firmado) pedido.eproc_firmado = {};
                            pedido.eproc_firmado.pdf_url = base64Data;
                            break;
                        case 'packing':
                            if (!pedido.packing_list) pedido.packing_list = {};
                            pedido.packing_list.pdf_url = base64Data;
                            break;
                        case 'etiquetas':
                            if (!pedido.etiquetas) pedido.etiquetas = {};
                            pedido.etiquetas.pdf_url = base64Data;
                            break;
                    }
                    
                    // Guardar cambios
                    guardarDatos();
                    
                    // Actualizar interfaz
                    mostrarPedidos();
                    
                    // Confirmar éxito y abrir el PDF
                    alert(`✅ ${nombreArchivo} cargado exitosamente.\n\n📄 El archivo se abrirá automáticamente.`);
                    
                    // Abrir el PDF recién cargado
                    setTimeout(() => {
                        abrirPDF(nombreArchivo, base64Data, pedidoId, tipo);
                    }, 500);
                };
                
                reader.onerror = function() {
                    alert('❌ Error al leer el archivo. Inténtalo de nuevo.');
                };
                
                reader.readAsDataURL(file);
                
            } catch (error) {
                console.error('Error al procesar PDF:', error);
                alert('❌ Error al procesar el archivo PDF. Inténtalo de nuevo.');
            }
        }

        function procesarArchivoPDF(file) {
            return new Promise((resolve, reject) => {
                if (file && file.type === 'application/pdf') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        resolve(e.target.result); // Devuelve base64
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                } else {
                    reject(new Error('Archivo no válido'));
                }
            });
        }

        // Estados
        function avanzarEstado(pedidoId) {
            if (confirm('¿Está seguro de que desea avanzar al siguiente estado?')) {
                const pedido = pedidos.find(p => p.id === pedidoId);
                const estadoIndex = ESTADOS.indexOf(pedido.estado);
                
                if (estadoIndex < ESTADOS.length - 1) {
                    pedido.estado = ESTADOS[estadoIndex + 1];
                    guardarDatos();
                    mostrarPedidos();
                }
            }
        }

        function retrocederEstado(pedidoId) {
            if (confirm('¿Está seguro de que desea retroceder al estado anterior?')) {
                const pedido = pedidos.find(p => p.id === pedidoId);
                const estadoIndex = ESTADOS.indexOf(pedido.estado);
                
                if (estadoIndex > 0) {
                    pedido.estado = ESTADOS[estadoIndex - 1];
                    guardarDatos();
                    mostrarPedidos();
                }
            }
        }

        // Form handlers
        document.getElementById('form-crear-pedido').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const grid = document.getElementById('pieces-grid');
            const piezas = [];
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseInt(row.children[3].value);
                const precio = parseFloat(row.children[4].value);
                
                piezas.push({
                    referencia: row.children[0].value,
                    descripcion: row.children[1].value,
                    proyecto: row.children[2].value,
                    cantidad: cantidad,
                    precio_unitario: precio,
                    precio_total: cantidad * precio
                });
                
                total += cantidad * precio;
            }
            
            // Procesar el PDF de la oferta
            const file = formData.get('oferta_pdf');
            let pdfUrl = '';
            
            if (file && file.size > 0) {
                try {
                    pdfUrl = await procesarArchivoPDF(file);
                } catch (error) {
                    alert('Error al procesar el archivo PDF');
                    return;
                }
            }
            
            const nuevoPedido = {
                id: nextId++,
                numero_oferta: formData.get('numero_oferta'),
                proveedor: formData.get('proveedor'),
                email_proveedor: formData.get('email_proveedor'),
                fecha_oferta: formData.get('fecha_oferta'),
                fecha_creacion: new Date().toLocaleDateString(),
                estado: 'oferta_recibida',
                piezas: piezas,
                total: total,
                oferta_pdf: pdfUrl
            };
            
            pedidos.push(nuevoPedido);
            guardarDatos();
            mostrarPedidos();
            cerrarModal();
        });

        // Nuevos form handlers
        document.getElementById('form-lanzar-eproc').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('lanzar-eproc-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                pedido.eproc = {
                    numero: formData.get('numero'),
                    oi: formData.get('oi'),
                    short_description: formData.get('short_description'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'eproc_lanzado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalLanzarEproc();
            }
        });

        document.getElementById('form-firmar-eproc').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('firmar-eproc-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const file = formData.get('pdf');
                let pdfUrl = '';
                
                if (file && file.size > 0) {
                    try {
                        pdfUrl = await procesarArchivoPDF(file);
                    } catch (error) {
                        alert('Error al procesar el archivo PDF');
                        return;
                    }
                }
                
                pedido.eproc_firmado = {
                    pdf: file ? file.name : 'PO_signed.pdf',
                    pdf_url: pdfUrl,
                    po: formData.get('po'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'eproc_firmado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalFirmarEproc();
            }
        });

        document.getElementById('form-packing-list').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('packing-list-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const file = formData.get('pdf');
                let pdfUrl = '';
                
                if (file && file.size > 0) {
                    try {
                        pdfUrl = await procesarArchivoPDF(file);
                    } catch (error) {
                        alert('Error al procesar el archivo PDF');
                        return;
                    }
                }
                
                const numBultos = parseInt(formData.get('bultos'));
                
                // Usar la configuración de bultos global si existe
                let configuracionBultos = {};
                let infoBultos = {};
                
                if (window.configuracionBultos) {
                    configuracionBultos = window.configuracionBultos;
                    infoBultos = window.infoBultos || {};
                } else {
                    // Fallback: crear configuración vacía
                    for (let i = 1; i <= numBultos; i++) {
                        configuracionBultos[`bulto_${i}`] = [];
                        infoBultos[`bulto_${i}`] = { peso: 0, dimensiones: '' };
                    }
                }
                
                pedido.packing_list = {
                    pdf: file ? file.name : 'packinglist.pdf',
                    pdf_url: pdfUrl,
                    bultos: numBultos,
                    fecha: formData.get('fecha'),
                    peso_total: parseFloat(formData.get('peso_total')) || 0
                };
                
                // Guardar configuración de bultos e información adicional
                pedido.configuracion_bultos = configuracionBultos;
                pedido.info_bultos = infoBultos;
                pedido.estado = 'packing_list_creado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalPackingList();
                
                // Limpiar variables globales
                window.configuracionBultos = null;
                window.piezasDisponibles = null;
                window.infoBultos = null;
            }
        });

        document.getElementById('form-lanzar-tar').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('lanzar-tar-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                pedido.tar = {
                    numero: formData.get('numero'),
                    email: formData.get('email'),
                    url: formData.get('url'),
                    fecha: formData.get('fecha')
                };
                pedido.estado = 'tar_lanzado';
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalLanzarTar();
            }
        });

        document.getElementById('form-enviar-etiquetas').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const pedidoId = parseInt(document.getElementById('enviar-etiquetas-pedido-id').value);
            const pedido = pedidos.find(p => p.id === pedidoId);
            
            if (pedido) {
                const file = formData.get('pdf');
                let pdfUrl = '';
                
                if (file && file.size > 0) {
                    try {
                        pdfUrl = await procesarArchivoPDF(file);
                    } catch (error) {
                        alert('Error al procesar el archivo PDF');
                        return;
                    }
                }
                
                const trackingNumber = formData.get('tracking');
                const fechaEnvio = formData.get('fecha');
                const direccionRecogida = formData.get('direccion_envio'); // Renombrado para mayor claridad
                
                // Guardar datos del pedido
                pedido.etiquetas = {
                    pdf: file ? file.name : 'etiquetas.pdf',
                    pdf_url: pdfUrl,
                    tracking: trackingNumber,
                    fecha: fechaEnvio,
                    direccion_recogida: direccionRecogida // Nombre correcto
                };
                pedido.estado = 'etiquetas_enviadas';
                
                // Generar email automático para Gmail
                generarEmailEtiquetas(pedido, trackingNumber, fechaEnvio);
                
                guardarDatos();
                mostrarPedidos();
                cerrarModalEnviarEtiquetas();
            }
        });

        // Form handler para crear TAR
        document.getElementById('form-crear-tar').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const grid = document.getElementById('tar-pieces-grid');
            const piezas = [];
            let total = 0;
            
            for (let i = 1; i < grid.children.length; i++) {
                const row = grid.children[i];
                const cantidad = parseInt(row.children[3].value);
                const precio = parseFloat(row.children[4].value);
                
                piezas.push({
                    referencia: row.children[0].value,
                    descripcion: row.children[1].value,
                    proyecto: row.children[2].value,
                    cantidad: cantidad,
                    precio_unitario: precio,
                    precio_total: cantidad * precio
                });
                
                total += cantidad * precio;
            }
            
            // Procesar el PDF de la oferta
            const file = formData.get('oferta_pdf');
            let pdfUrl = '';
            
            if (file && file.size > 0) {
                try {
                    pdfUrl = await procesarArchivoPDF(file);
                } catch (error) {
                    alert('Error al procesar el archivo PDF');
                    return;
                }
            }
            
            const nuevoTar = {
                id: nextId++,
                numero_oferta: formData.get('numero_oferta'),
                proveedor: formData.get('proveedor'),
                email_proveedor: formData.get('email_proveedor'),
                fecha_oferta: formData.get('fecha_oferta'),
                fecha_creacion: new Date().toLocaleDateString(),
                estado: 'eproc_firmado', // TAR empieza en eproc_firmado (saltando oferta_recibida y eproc_lanzado)
                piezas: piezas,
                total: total,
                oferta_pdf: pdfUrl,
                tipo: 'TAR', // Identificador para distinguir TARs de pedidos normales
                // Datos predefinidos de EPROC (porque el TAR ya tiene esta info)
                eproc: {
                    numero: formData.get('numero_eproc'),
                    oi: formData.get('oi_eproc'),
                    fecha: new Date().toLocaleDateString()
                }
            };
            
            pedidos.push(nuevoTar);
            guardarDatos();
            mostrarPedidos();
            cerrarModalCrearTar();
        });

        // Cerrar modals al hacer click fuera
        window.onclick = function(event) {
            const modals = [
                'modal-crear-pedido',
                'modal-lanzar-eproc', 
                'modal-firmar-eproc',
                'modal-packing-list',
                'modal-lanzar-tar',
                'modal-enviar-etiquetas',
                'modal-detalle-completo',
                'modal-short-description',
                'modal-crear-tar',
                'modal-seguimiento-dhl',
                'modal-nota'
            ];
            
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                    // Limpiar iframe de DHL al cerrar
                    if (modalId === 'modal-seguimiento-dhl') {
                        document.getElementById('dhl-iframe').src = '';
                    }
                }
            });
        }

        // Event listeners para Short Description Generator
        document.addEventListener("DOMContentLoaded", function() {
            const inputIds = ['sd-oferta', 'sd-pieza', 'sd-descripcion', 'sd-proyecto', 'sd-precio'];
            
            inputIds.forEach((id, idx) => {
                const input = document.getElementById(id);
                
                // Evento de Enter para navegar (excepto en el último campo)
                if (id !== 'sd-precio') {
                    input.addEventListener('keydown', function(event) {
                        if (event.key === "Enter") {
                            event.preventDefault();
                            if (idx < inputIds.length - 1) {
                                document.getElementById(inputIds[idx + 1]).focus();
                            }
                        }
                    });
                }
                
                // Removido: Auto-generar cuando se complete el último campo
                // La generación ahora solo se hace manualmente con el botón
            });
        });

        // ===============================
        // FUNCIÓN PARA EMAIL DE ETIQUETAS
        // ===============================

        function generarEmailEtiquetas(pedido, trackingNumber, fechaEnvio) {
            try {
                // Confirmación antes de abrir Gmail
                const confirmar = confirm('📧 ¿Deseas ser redireccionado a Gmail para generar el correo automáticamente?\n\nSe abrirá Gmail con toda la información ya completada.');
                
                if (!confirmar) {
                    return; // El usuario canceló
                }
                
                // Obtener información del proveedor
                const proveedor = pedido.proveedor || 'Proveedor';
                const emailProveedor = pedido.email_proveedor || '';
                
                // Obtener información del PO desde eproc_firmado
                const numeroPO = pedido.eproc_firmado?.po || 'Not available';
                
                // Información de los bultos - usar configuración de packing list
                let infoBultos = '';
                if (pedido.configuracion_bultos && pedido.info_bultos) {
                    infoBultos = generarInfoBultosDetallada(pedido.configuracion_bultos, pedido.info_bultos);
                } else if (pedido.packing_list && pedido.packing_list.bultos > 1) {
                    infoBultos = `PACKAGE DISTRIBUTION:\n- ${pedido.packing_list.bultos} packages total\n`;
                } else {
                    infoBultos = 'PACKAGE DISTRIBUTION:\n- 1 package containing all items\n';
                }
                
                // Actualizar direcciones según especificaciones
                const direccionRecogida = pedido.etiquetas?.direccion_recogida || 'No especificada'; // Dirección de recogida desde el modal (sin defecto)
                const direccionEntrega = 'C/ Linares Pol Cañada Fuente15\n23600 MARTOS\nSpain'; // Dirección fija de entrega correcta
                
                // Crear asunto del email
                const asunto = `Shipping Labels Ready - Order #${pedido.numero_oferta || pedido.id} - Tracking: ${trackingNumber || 'TBD'}`;
                
                // Crear cuerpo del email con el formato solicitado
                const cuerpoEmail = `Hello,

Labels for shipping are ready.

ORDER DETAILS:
PO: ${numeroPO}
Tracking Number: ${trackingNumber || 'To be provided by courier'}

${infoBultos}
SHIPPING INFORMATION:
Pickup: ${direccionRecogida}
Delivery: ${direccionEntrega}

Best regards,
Logistics Team`.trim();

                // Crear URL para Gmail
                const gmailBaseUrl = 'https://mail.google.com/mail/?view=cm&fs=1';
                const emailParams = new URLSearchParams({
                    to: emailProveedor,
                    su: asunto,
                    body: cuerpoEmail
                });
                
                const gmailUrl = `${gmailBaseUrl}&${emailParams.toString()}`;
                
                // Abrir Gmail en nueva pestaña
                window.open(gmailUrl, '_blank');
                
                console.log('📧 Email generado para etiquetas:', {
                    pedido: pedido.id,
                    tracking: trackingNumber,
                    proveedor: proveedor,
                    asunto: asunto,
                    po: numeroPO
                });
                
            } catch (error) {
                console.error('Error al generar email de etiquetas:', error);
                alert('❌ Error al generar el email automático.\n\nPuedes crear el email manualmente con la información del pedido.');
            }
        }
        
        function generarInfoBultosDetallada(configuracionBultos, infoBultos) {
            if (!configuracionBultos || Object.keys(configuracionBultos).length === 0) {
                return 'PACKAGE DISTRIBUTION:\n- 1 package containing all items\n';
            }
            
            let info = 'PACKAGE DISTRIBUTION:\n';
            
            Object.keys(configuracionBultos).forEach((bultoClave, index) => {
                const numeroBulto = index + 1;
                const piezasEnBulto = configuracionBultos[bultoClave];
                const infoBulto = infoBultos[bultoClave] || {};
                
                info += `\nPackage ${numeroBulto}:\n`;
                
                if (infoBulto.peso) {
                    info += `• Weight: ${infoBulto.peso} kg\n`;
                }
                if (infoBulto.dimensiones) {
                    info += `• Dimensions: ${infoBulto.dimensiones}\n`;
                }
                
                if (piezasEnBulto && piezasEnBulto.length > 0) {
                    info += `• Contents:\n`;
                    piezasEnBulto.forEach(pieza => {
                        info += `  - ${pieza.referencia} x${pieza.cantidad}\n`;
                    });
                }
            });
            
            return info;
        }

        function generarInfoBultos(bultos) {
            if (!bultos || bultos.length === 0) {
                return 'PACKAGE DISTRIBUTION:\n- 1 standard package\n';
            }
            
            let info = 'PACKAGE DISTRIBUTION:\n';
            bultos.forEach((bulto, index) => {
                info += `\nPackage ${index + 1}:\n`;
                info += `• Weight: ${bulto.peso || 'Not specified'} kg\n`;
                info += `• Dimensions: ${bulto.dimensiones || 'Not specified'}\n`;
                
                if (bulto.piezas && bulto.piezas.length > 0) {
                    info += `• Contents:\n`;
                    bulto.piezas.forEach(pieza => {
                        info += `  - ${pieza.referencia} (${pieza.cantidad_en_bulto} units)\n`;
                    });
                }
            });
            
            return info;
        }

        // ===============================
        // FUNCIÓN PARA TAR EXTERNO
        // ===============================

        function abrirFormularioTarExterno() {
            window.open('https://docs.google.com/forms/d/e/1FAIpQLScCqYEia5vQKhV7FOZarTAHP3XsHNhVkADohdrEa6vc7jwKFQ/viewform', '_blank');
        }

        function abrirEproc() {
            window.open('https://valeo.determine.com/t/ui/md/landing/summary/-/LANDINGPAGE', '_blank');
        }
    </script>
</body>
</html><!-- Cache Buster: 20250804100120 -->
